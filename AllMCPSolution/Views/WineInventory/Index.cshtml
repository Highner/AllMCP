@model AllMCPSolution.Controllers.WineInventoryViewModel
@using Microsoft.AspNetCore.WebUtilities
@using System.Collections.Generic
@using System.Linq
@{
    Layout = null;
    string BuildSortUrl(string field)
    {
        var nextDir = string.Equals(Model.SortField, field, StringComparison.OrdinalIgnoreCase) &&
                      !string.Equals(Model.SortDirection, "desc", StringComparison.OrdinalIgnoreCase)
            ? "desc"
            : "asc";

        var parameters = new Dictionary<string, string?>
        {
            ["status"] = string.Equals(Model.Status, "all", StringComparison.OrdinalIgnoreCase) ? null : Model.Status,
            ["color"] = string.IsNullOrWhiteSpace(Model.Color) ? null : Model.Color,
            ["search"] = string.IsNullOrWhiteSpace(Model.Search) ? null : Model.Search,
            ["sortField"] = field,
            ["sortDir"] = nextDir
        };

        var filtered = parameters
            .Where(kvp => !string.IsNullOrWhiteSpace(kvp.Value))
            .ToDictionary(kvp => kvp.Key, kvp => kvp.Value!);

        return QueryHelpers.AddQueryString("/wine-manager", filtered);
    }

    bool IsSorted(string field) => string.Equals(Model.SortField, field, StringComparison.OrdinalIgnoreCase);

    string SortStateClass(string field)
    {
        if (!IsSorted(field))
        {
            return string.Empty;
        }

        return string.Equals(Model.SortDirection, "desc", StringComparison.OrdinalIgnoreCase) ? "sorted-desc" : "sorted-asc";
    }
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wine Waves</title>
    <style>
        body {
            background-color: #050505;
            color: #f4f1ea;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 40px;
        }

        h1 {
            font-size: 48px;
            margin-bottom: 30px;
            letter-spacing: 4px;
            text-transform: uppercase;
            text-align: center;
        }

        .inventory-shell {
            max-width: 1200px;
            margin: 0 auto;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
        }

        .filters label {
            display: flex;
            flex-direction: column;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #d7d2c4;
        }

        .filters select,
        .filters input[type="text"] {
            margin-top: 6px;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid rgba(244, 241, 234, 0.3);
            background: rgba(10, 10, 10, 0.85);
            color: #f4f1ea;
            min-width: 200px;
        }

        .filters button {
            align-self: flex-end;
            padding: 12px 24px;
            border-radius: 6px;
            border: none;
            background: #f4f1ea;
            color: #050505;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filters button:hover {
            background: #d7d2c4;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            overflow: hidden;
        }

        thead {
            background: rgba(255, 255, 255, 0.08);
        }

        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid rgba(244, 241, 234, 0.06);
        }

        thead th {
            font-size: 12px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        th a {
            color: inherit;
            text-decoration: none;
        }

        th a:hover {
            text-decoration: underline;
        }

        .sort-header {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .sort-icon {
            display: none;
            font-size: 12px;
        }

        .sort-header.sorted-asc .sort-icon,
        .sort-header.sorted-desc .sort-icon {
            display: inline-block;
        }

        .sort-header.sorted-asc .sort-icon::before {
            content: "▲";
        }

        .sort-header.sorted-desc .sort-icon::before {
            content: "▼";
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .group-row {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .group-row.selected {
            background: rgba(255, 255, 255, 0.12);
        }

        .status-pill {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .status-pill.drunk {
            background: rgba(255, 99, 132, 0.2);
            color: #ff6384;
        }

        .status-pill.cellared {
            background: rgba(75, 192, 192, 0.2);
            color: #4bc0c0;
        }

        .status-pill.mixed {
            background: rgba(153, 102, 255, 0.2);
            color: #9966ff;
        }

        .details-panel {
            margin-top: 32px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 24px;
        }

        .details-panel header {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 20px;
        }

        .details-panel h2 {
            margin: 0;
            font-size: 24px;
            letter-spacing: 1.2px;
        }

        .details-panel p {
            margin: 0;
            font-size: 14px;
            color: rgba(244, 241, 234, 0.7);
        }

        .details-message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.08);
            display: none;
        }

        .details-message[data-state="error"] {
            background: rgba(255, 99, 132, 0.18);
            color: #ffb3c7;
        }

        .details-message[data-state="success"] {
            background: rgba(75, 192, 192, 0.2);
            color: #a9ecec;
        }

        .details-message[data-state="info"] {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(244, 241, 234, 0.85);
        }

        .details-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 16px;
        }

        .details-controls label {
            display: flex;
            flex-direction: column;
            font-size: 13px;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: rgba(244, 241, 234, 0.75);
        }

        .details-controls input,
        .details-controls button,
        .details-table input,
        .details-table button,
        .details-table select {
            font: inherit;
        }

        .details-controls input,
        .details-table input,
        .details-table select {
            margin-top: 6px;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid rgba(244, 241, 234, 0.25);
            background: rgba(10, 10, 10, 0.9);
            color: #f4f1ea;
            min-width: 140px;
        }

        .details-controls input[type="checkbox"],
        .details-table input[type="checkbox"] {
            min-width: auto;
            width: 18px;
            height: 18px;
            margin-top: 0;
        }

        .details-controls button,
        .details-table button {
            padding: 10px 16px;
            border-radius: 6px;
            border: none;
            background: #f4f1ea;
            color: #050505;
            font-weight: 600;
            cursor: pointer;
        }

        .details-controls button:disabled,
        .details-table button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            overflow: hidden;
        }

        .details-table th,
        .details-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(244, 241, 234, 0.05);
            font-size: 14px;
        }

        .details-table thead {
            background: rgba(255, 255, 255, 0.07);
        }

        .details-table tbody tr:last-child td {
            border-bottom: none;
        }

        .details-table tbody tr.loading td {
            opacity: 0.5;
        }

        .details-table .actions {
            display: flex;
            gap: 8px;
        }

        .details-table tbody .actions button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(244, 241, 234, 0.2);
            background: transparent;
            color: #f4f1ea;
            cursor: pointer;
        }

        .details-table tbody .actions button:hover {
            background: rgba(244, 241, 234, 0.12);
        }

        .details-table tbody .actions button.secondary {
            border-color: rgba(255, 99, 132, 0.45);
            color: #ffb3c7;
        }

        .details-table tbody .actions button.secondary:hover {
            background: rgba(255, 99, 132, 0.15);
        }

        .inventory-table .actions {
            display: flex;
            gap: 8px;
        }

        .inventory-table .actions button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(244, 241, 234, 0.2);
            background: transparent;
            color: #f4f1ea;
            cursor: pointer;
        }

        .inventory-table .actions button.secondary:hover {
            background: rgba(244, 241, 234, 0.12);
        }

        .inventory-table thead .header-row {
            background: rgba(255, 255, 255, 0.07);
        }

        .inventory-table thead tr.add-summary-row {
            background: rgba(255, 255, 255, 0.03);
        }

        .inventory-table thead tr.add-summary-row td {
            border-bottom: 1px solid rgba(244, 241, 234, 0.05);
        }

        .summary-add-row input,
        .summary-add-row select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid rgba(244, 241, 234, 0.25);
            background: rgba(10, 10, 10, 0.9);
            color: #f4f1ea;
            font: inherit;
            min-width: 0;
            box-sizing: border-box;
        }

        .summary-add-row .actions button {
            width: 100%;
            padding: 10px 12px;
            border-radius: 6px;
            border: none;
            background: #f4f1ea;
            color: #050505;
            font-weight: 600;
            cursor: pointer;
        }

        .summary-add-row .actions button:hover {
            background: #d7d2c4;
        }

        .details-table .add-row input,
        .details-table .add-row select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid rgba(244, 241, 234, 0.2);
            background: rgba(10, 10, 10, 0.85);
            color: #f4f1ea;
            min-width: 0;
            box-sizing: border-box;
        }

        .details-table .add-row .actions button {
            width: 100%;
        }

        .details-table .empty-row td {
            text-align: center;
            padding: 24px;
            color: rgba(244, 241, 234, 0.7);
        }

        .details-controls .checkbox-row,
        .details-table .checkbox-row {
            align-items: center;
            display: flex;
            gap: 8px;
            flex-direction: row;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="inventory-shell">
        <h1>Wine Waves</h1>
        <form method="get" class="filters">
            <label>
                Status
                <select name="status">
                    @foreach (var option in Model.StatusOptions)
                    {
                        var isSelected = string.Equals(option.Value, Model.Status, StringComparison.OrdinalIgnoreCase) ||
                                         (string.IsNullOrEmpty(option.Value) && string.Equals(Model.Status, "all", StringComparison.OrdinalIgnoreCase));
                        <option value="@option.Value" selected="@(isSelected ? "selected" : null)">@option.Label</option>
                    }
                </select>
            </label>
            <label>
                Color
                <select name="color">
                    @foreach (var option in Model.ColorOptions)
                    {
                        var currentColor = Model.Color ?? string.Empty;
                        var isSelected = string.Equals(option.Value, currentColor, StringComparison.OrdinalIgnoreCase);
                        <option value="@option.Value" selected="@(isSelected ? "selected" : null)">@option.Label</option>
                    }
                </select>
            </label>
            <label>
                Search
                <input type="text" name="search" value="@Model.Search" placeholder="Wine, appellation, vintage" />
            </label>
            <input type="hidden" name="sortField" value="@Model.SortField" />
            <input type="hidden" name="sortDir" value="@Model.SortDirection" />
            <button type="submit">Apply</button>
        </form>

        @if (!Model.Bottles.Any())
        {
            <div class="no-results">No bottles match the current filters.</div>
        }
        else
        {
            <table id="inventory-table" class="inventory-table">
                <thead>
                    <tr class="add-summary-row">
                        <td>
                            <input type="text" class="summary-add-name" placeholder="Wine name" aria-label="Wine name" />
                        </td>
                        <td>
                            <select class="summary-add-sub-app" aria-label="Sub-appellation">
                                <option value="">Select sub-appellation</option>
                            </select>
                        </td>
                        <td>
                            <input type="number" class="summary-add-vintage" min="1900" max="2100" placeholder="Vintage" aria-label="Vintage" />
                        </td>
                        <td>
                            <input type="number" class="summary-add-count" min="1" value="1" aria-label="Initial bottle count" />
                        </td>
                        <td>
                            <select class="summary-add-color" aria-label="Color">
                                <option value="Red">Red</option>
                                <option value="White">White</option>
                                <option value="Rose">Rosé</option>
                            </select>
                        </td>
                        <td class="summary-add-status">—</td>
                        <td class="summary-add-score">—</td>
                        <td>
                            <div class="actions">
                                <button type="button" class="summary-add-submit">Add Wine</button>
                            </div>
                        </td>
                    </tr>
                    <tr class="header-row">
                        <th>
                            <a class="sort-header @SortStateClass("wine")" href="@BuildSortUrl("wine")">
                                <span class="header-text">Wine</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </a>
                        </th>
                        <th>
                            <a class="sort-header @SortStateClass("appellation")" href="@BuildSortUrl("appellation")">
                                <span class="header-text">Appellation</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </a>
                        </th>
                        <th>
                            <a class="sort-header @SortStateClass("vintage")" href="@BuildSortUrl("vintage")">
                                <span class="header-text">Vintage</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </a>
                        </th>
                        <th>
                            <span class="header-text">Bottles</span>
                        </th>
                        <th>
                            <a class="sort-header @SortStateClass("color")" href="@BuildSortUrl("color")">
                                <span class="header-text">Color</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </a>
                        </th>
                        <th>
                            <a class="sort-header @SortStateClass("status")" href="@BuildSortUrl("status")">
                                <span class="header-text">Status</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </a>
                        </th>
                        <th>
                            <a class="sort-header @SortStateClass("score")" href="@BuildSortUrl("score")">
                                <span class="header-text">Score</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </a>
                        </th>
                        <th>
                            <span class="header-text">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var bottle in Model.Bottles)
                    {
                        var subAppellation = string.IsNullOrWhiteSpace(bottle.SubAppellation) ? null : bottle.SubAppellation;
                        var appellation = string.IsNullOrWhiteSpace(bottle.Appellation) ? null : bottle.Appellation;
                        var display = "—";
                        if (!string.IsNullOrEmpty(subAppellation) && !string.IsNullOrEmpty(appellation) && !string.Equals(subAppellation, appellation, StringComparison.OrdinalIgnoreCase))
                        {
                            display = $"{subAppellation} ({appellation})";
                        }
                        else if (!string.IsNullOrEmpty(subAppellation))
                        {
                            display = subAppellation;
                        }
                        else if (!string.IsNullOrEmpty(appellation))
                        {
                            display = appellation;
                        }
                        <tr class="group-row"
                            data-group-id="@bottle.WineVintageId"
                            data-wine-id="@bottle.WineId"
                            data-sub-appellation-id="@(bottle.SubAppellationId?.ToString() ?? string.Empty)"
                            data-appellation-id="@(bottle.AppellationId?.ToString() ?? string.Empty)"
                            tabindex="0"
                            role="button"
                            aria-controls="details-table">
                            <td class="summary-wine">@bottle.WineName</td>
                            <td class="summary-appellation">@display</td>
                            <td class="summary-vintage">@bottle.Vintage</td>
                            <td class="summary-bottles" data-field="bottle-count">@bottle.BottleCount</td>
                            <td class="summary-color">@bottle.Color</td>
                            <td class="summary-status"><span class="status-pill @bottle.StatusCssClass" data-field="status">@bottle.StatusLabel</span></td>
                            <td class="summary-score" data-field="score">@(bottle.AverageScore.HasValue ? bottle.AverageScore.Value.ToString("0.0") : "—")</td>
                            <td class="summary-actions">
                                <div class="actions">
                                    <button type="button" class="secondary edit-group">Edit</button>
                                    <button type="button" class="secondary delete-group">Delete</button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <section class="details-panel" aria-live="polite">
                <header>
                    <h2 id="details-title">Bottle Details</h2>
                    <p id="details-subtitle">Select a wine group to view individual bottles.</p>
                </header>
                <div id="details-message" class="details-message" role="status"></div>
                <table class="details-table" id="details-table">
                    <thead>
                        <tr class="add-row" id="detail-add-row" hidden>
                            <td>
                                <select class="detail-add-location" aria-label="Bottle location">
                                    <option value="">No location</option>
                                </select>
                            </td>
                            <td>
                                <input type="number" class="detail-add-price" step="0.01" min="0" placeholder="0.00" aria-label="Price" />
                            </td>
                            <td>
                                <label class="checkbox-row">
                                    <input type="checkbox" class="detail-add-is-drunk" />
                                    <span>No</span>
                                </label>
                            </td>
                            <td>
                                <input type="datetime-local" class="detail-add-drunk-at" aria-label="Drunk date" disabled />
                            </td>
                            <td class="actions">
                                <button type="button" class="detail-add-submit">Add Bottle</button>
                            </td>
                        </tr>
                        <tr class="header-row">
                            <th scope="col">Bottle Location</th>
                            <th scope="col">Price</th>
                            <th scope="col">Drunk</th>
                            <th scope="col">Drunk Date</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="empty-row">
                            <td colspan="5">Select a wine group to see its bottles.</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        }
    </div>
    <script>
        (function () {
            const inventoryTable = document.getElementById('inventory-table');
            const detailsTable = document.getElementById('details-table');
            const detailsBody = detailsTable?.querySelector('tbody');
            const detailAddRow = detailsTable?.querySelector('#detail-add-row');
            const emptyRow = detailsBody?.querySelector('.empty-row');
            const detailsTitle = document.getElementById('details-title');
            const detailsSubtitle = document.getElementById('details-subtitle');
            const messageBanner = document.getElementById('details-message');

            if (!inventoryTable || !detailsTable || !detailsBody || !detailAddRow || !emptyRow || !detailsTitle || !detailsSubtitle || !messageBanner) {
                return;
            }

            const summaryAddRow = inventoryTable.querySelector('.add-summary-row');
            const summaryAddName = summaryAddRow?.querySelector('.summary-add-name');
            const summaryAddSubApp = summaryAddRow?.querySelector('.summary-add-sub-app');
            const summaryAddVintage = summaryAddRow?.querySelector('.summary-add-vintage');
            const summaryAddCount = summaryAddRow?.querySelector('.summary-add-count');
            const summaryAddColor = summaryAddRow?.querySelector('.summary-add-color');
            const summaryAddButton = summaryAddRow?.querySelector('.summary-add-submit');

            const detailAddLocation = detailAddRow.querySelector('.detail-add-location');
            const detailAddPrice = detailAddRow.querySelector('.detail-add-price');
            const detailAddIsDrunk = detailAddRow.querySelector('.detail-add-is-drunk');
            const detailAddLabel = detailAddRow.querySelector('.checkbox-row span');
            const detailAddDrunkAt = detailAddRow.querySelector('.detail-add-drunk-at');
            const detailAddButton = detailAddRow.querySelector('.detail-add-submit');

            let selectedGroupId = null;
            let selectedSummary = null;
            let selectedRow = null;
            let loading = false;

            const referenceData = {
                subAppellations: [],
                bottleLocations: []
            };
            const referenceDataPromise = loadReferenceData();

            initializeSummaryRows();
            bindSummaryAddRow();
            bindDetailAddRow();

            function initializeSummaryRows() {
                const rows = Array.from(inventoryTable.querySelectorAll('tbody tr.group-row'));
                rows.forEach(attachSummaryRowHandlers);
            }

            function attachSummaryRowHandlers(row) {
                row.addEventListener('click', (event) => {
                    const target = event.target;

                    if (target.closest('.save-group')) {
                        event.stopPropagation();
                        saveSummaryEdit(row);
                        return;
                    }

                    if (target.closest('.cancel-group')) {
                        event.stopPropagation();
                        cancelSummaryEdit(row);
                        return;
                    }

                    if (target.closest('.edit-group')) {
                        event.stopPropagation();
                        referenceDataPromise
                            .then(() => enterEditMode(row))
                            .catch(error => showMessage(error?.message ?? String(error), 'error'));
                        return;
                    }

                    if (target.closest('.delete-group')) {
                        event.stopPropagation();
                        handleSummaryDelete(row);
                        return;
                    }

                    if (row.classList.contains('editing')) {
                        return;
                    }

                    if (target.closest('.summary-actions')) {
                        return;
                    }

                    handleRowSelection(row).catch(error => showMessage(error?.message ?? String(error), 'error'));
                });

                row.addEventListener('keydown', (event) => {
                    if (row.classList.contains('editing')) {
                        return;
                    }

                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        handleRowSelection(row).catch(error => showMessage(error?.message ?? String(error), 'error'));
                    }
                });
            }

            function bindSummaryAddRow() {
                if (!summaryAddButton) {
                    return;
                }

                summaryAddButton.addEventListener('click', async () => {
                    await referenceDataPromise;

                    if (loading) {
                        return;
                    }

                    const name = summaryAddName?.value?.trim() ?? '';
                    const subAppellationId = summaryAddSubApp?.value ?? '';
                    const vintageValue = Number(summaryAddVintage?.value ?? '');
                    const bottleCountValue = Number(summaryAddCount?.value ?? '');
                    const color = summaryAddColor?.value ?? '';

                    if (!name) {
                        showMessage('Wine name is required.', 'error');
                        return;
                    }

                    if (!subAppellationId) {
                        showMessage('Select a sub-appellation for the wine.', 'error');
                        return;
                    }

                    if (!Number.isInteger(vintageValue)) {
                        showMessage('Enter a valid vintage year.', 'error');
                        return;
                    }

                    if (!Number.isInteger(bottleCountValue) || bottleCountValue < 1) {
                        showMessage('Initial bottle count must be at least 1.', 'error');
                        return;
                    }

                    if (!color) {
                        showMessage('Choose a wine color.', 'error');
                        return;
                    }

                    const payload = {
                        wineName: name,
                        subAppellationId,
                        vintage: vintageValue,
                        color,
                        initialBottleCount: bottleCountValue
                    };

                    try {
                        setLoading(true);
                        const response = await sendJson('/wine-manager/groups', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });

                        if (summaryAddName) {
                            summaryAddName.value = '';
                        }

                        if (summaryAddSubApp) {
                            summaryAddSubApp.value = '';
                        }

                        if (summaryAddVintage) {
                            summaryAddVintage.value = '';
                        }

                        if (summaryAddCount) {
                            summaryAddCount.value = '1';
                        }

                        if (summaryAddColor) {
                            summaryAddColor.value = 'Red';
                        }

                        const summary = normalizeSummary(response?.group ?? response?.Group);
                        if (!summary) {
                            showMessage('Wine group created, but it could not be displayed.', 'warning');
                            return;
                        }

                        const newRow = buildSummaryRow(summary);
                        attachSummaryRowHandlers(newRow);
                        inventoryTable.querySelector('tbody')?.appendChild(newRow);
                        showMessage('Wine group created.', 'success');
                        await handleRowSelection(newRow, { force: true, response });
                        newRow.focus();
                    } catch (error) {
                        showMessage(error.message, 'error');
                    } finally {
                        setLoading(false);
                    }
                });
            }

            function bindDetailAddRow() {
                detailAddIsDrunk?.addEventListener('change', () => {
                    if (detailAddIsDrunk.checked) {
                        detailAddDrunkAt.removeAttribute('disabled');
                        if (detailAddLabel) {
                            detailAddLabel.textContent = 'Yes';
                        }
                    } else {
                        detailAddDrunkAt.value = '';
                        detailAddDrunkAt.setAttribute('disabled', 'disabled');
                        if (detailAddLabel) {
                            detailAddLabel.textContent = 'No';
                        }
                    }
                });

                detailAddButton?.addEventListener('click', handleAddBottle);
            }

            async function loadReferenceData() {
                try {
                    const response = await sendJson('/wine-manager/options', { method: 'GET' });
                    const subApps = Array.isArray(response?.subAppellations)
                        ? response.subAppellations
                        : Array.isArray(response?.SubAppellations)
                            ? response.SubAppellations
                            : [];
                    const locations = Array.isArray(response?.bottleLocations)
                        ? response.bottleLocations
                        : Array.isArray(response?.BottleLocations)
                            ? response.BottleLocations
                            : [];

                    referenceData.subAppellations = subApps;
                    referenceData.bottleLocations = locations;

                    populateSubAppellationSelect(summaryAddSubApp, summaryAddSubApp?.value ?? '');
                    populateLocationSelect(detailAddLocation, detailAddLocation?.value ?? '');
                } catch (error) {
                    showMessage(error.message, 'error');
                }
            }

            function populateSubAppellationSelect(select, selectedId) {
                if (!select) {
                    return;
                }

                const previousValue = selectedId ?? select.value ?? '';
                select.innerHTML = '';

                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Select sub-appellation';
                select.appendChild(placeholder);

                referenceData.subAppellations.forEach(option => {
                    const id = option?.id ?? option?.Id;
                    const label = option?.label ?? option?.Label;
                    if (!id) {
                        return;
                    }

                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = label ?? id;
                    select.appendChild(opt);
                });

                if (previousValue) {
                    select.value = previousValue;
                }
            }

            function populateLocationSelect(select, selectedId) {
                if (!select) {
                    return;
                }

                const previousValue = selectedId ?? select.value ?? '';
                select.innerHTML = '';

                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'No location';
                select.appendChild(placeholder);

                referenceData.bottleLocations.forEach(option => {
                    const id = option?.id ?? option?.Id;
                    const name = option?.name ?? option?.Name;
                    if (!id) {
                        return;
                    }

                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = name ?? id;
                    select.appendChild(opt);
                });

                if (previousValue) {
                    select.value = previousValue;
                }
            }

            function buildSummaryRow(summary) {
                const row = document.createElement('tr');
                row.className = 'group-row';
                row.setAttribute('tabindex', '0');
                row.setAttribute('role', 'button');
                row.setAttribute('aria-controls', 'details-table');
                applySummaryToRow(row, summary, true);
                return row;
            }

            function ensureSummaryRowStructure(row) {
                if (row.querySelector('.summary-wine')) {
                    return;
                }

                row.innerHTML = `
                    <td class="summary-wine"></td>
                    <td class="summary-appellation"></td>
                    <td class="summary-vintage"></td>
                    <td class="summary-bottles" data-field="bottle-count"></td>
                    <td class="summary-color"></td>
                    <td class="summary-status"><span class="status-pill" data-field="status"></span></td>
                    <td class="summary-score" data-field="score"></td>
                    <td class="summary-actions">
                        <div class="actions">
                            <button type="button" class="secondary edit-group">Edit</button>
                            <button type="button" class="secondary delete-group">Delete</button>
                        </div>
                    </td>`;
            }

            function applySummaryToRow(row, summary, isNewRow = false) {
                ensureSummaryRowStructure(row);

                row.dataset.groupId = summary?.wineVintageId ?? summary?.WineVintageId ?? '';
                row.dataset.wineId = summary?.wineId ?? summary?.WineId ?? '';
                row.dataset.subAppellationId = summary?.subAppellationId ?? summary?.SubAppellationId ?? '';
                row.dataset.appellationId = summary?.appellationId ?? summary?.AppellationId ?? '';

                const wineCell = row.querySelector('.summary-wine');
                const appCell = row.querySelector('.summary-appellation');
                const vintageCell = row.querySelector('.summary-vintage');
                const bottlesCell = row.querySelector('.summary-bottles');
                const colorCell = row.querySelector('.summary-color');
                const statusSpan = row.querySelector('[data-field="status"]');
                const scoreCell = row.querySelector('[data-field="score"]');
                const actionsCell = row.querySelector('.summary-actions .actions');

                if (wineCell) {
                    wineCell.textContent = summary?.wineName ?? summary?.WineName ?? '';
                }

                if (appCell) {
                    appCell.textContent = buildAppellationDisplay(summary);
                }

                if (vintageCell) {
                    const vintageValue = summary?.vintage ?? summary?.Vintage;
                    vintageCell.textContent = vintageValue != null ? String(vintageValue) : '';
                }

                if (bottlesCell) {
                    const count = summary?.bottleCount ?? summary?.BottleCount ?? 0;
                    bottlesCell.textContent = Number(count).toString();
                }

                if (colorCell) {
                    colorCell.textContent = summary?.color ?? summary?.Color ?? '';
                }

                if (statusSpan) {
                    const label = summary?.statusLabel ?? summary?.StatusLabel ?? '';
                    const cssClass = summary?.statusCssClass ?? summary?.StatusCssClass ?? '';
                    statusSpan.textContent = label;
                    statusSpan.className = `status-pill ${cssClass}`;
                }

                if (scoreCell) {
                    const score = summary?.averageScore ?? summary?.AverageScore;
                    scoreCell.textContent = score != null ? Number(score).toFixed(1) : '—';
                }

                if (actionsCell) {
                    actionsCell.innerHTML = `
                        <button type="button" class="secondary edit-group">Edit</button>
                        <button type="button" class="secondary delete-group">Delete</button>`;
                }

                if (isNewRow) {
                    row.classList.remove('editing', 'selected');
                }
            }

            async function enterEditMode(row) {
                if (row.classList.contains('editing') || loading) {
                    return;
                }

                await referenceDataPromise;

                const summary = extractSummaryFromRow(row);
                row.dataset.originalSummary = JSON.stringify(summary);
                row.classList.add('editing');

                const wineCell = row.querySelector('.summary-wine');
                const appCell = row.querySelector('.summary-appellation');
                const vintageCell = row.querySelector('.summary-vintage');
                const colorCell = row.querySelector('.summary-color');
                const actionsCell = row.querySelector('.summary-actions .actions');

                if (wineCell) {
                    wineCell.innerHTML = `<input type="text" class="summary-edit-name" value="${escapeHtml(summary.wineName ?? '')}" />`;
                }

                if (appCell) {
                    const select = document.createElement('select');
                    select.className = 'summary-edit-sub-app';
                    populateSubAppellationSelect(select, summary.subAppellationId ?? '');
                    appCell.innerHTML = '';
                    appCell.appendChild(select);
                }

                if (vintageCell) {
                    vintageCell.innerHTML = `<input type="number" class="summary-edit-vintage" min="1900" max="2100" value="${summary.vintage ?? ''}" />`;
                }

                if (colorCell) {
                    const select = document.createElement('select');
                    select.className = 'summary-edit-color';
                    select.innerHTML = `
                        <option value="Red">Red</option>
                        <option value="White">White</option>
                        <option value="Rose">Rosé</option>`;
                    select.value = summary.color ?? 'Red';
                    colorCell.innerHTML = '';
                    colorCell.appendChild(select);
                }

                if (actionsCell) {
                    actionsCell.innerHTML = `
                        <button type="button" class="save-group">Save</button>
                        <button type="button" class="secondary cancel-group">Cancel</button>`;
                }
            }

            function cancelSummaryEdit(row) {
                const original = row.dataset.originalSummary
                    ? JSON.parse(row.dataset.originalSummary)
                    : extractSummaryFromRow(row);

                applySummaryToRow(row, original);
                row.classList.remove('editing');
            }

            async function saveSummaryEdit(row) {
                if (!row.classList.contains('editing') || loading) {
                    return;
                }

                await referenceDataPromise;

                const nameInput = row.querySelector('.summary-edit-name');
                const subAppSelect = row.querySelector('.summary-edit-sub-app');
                const vintageInput = row.querySelector('.summary-edit-vintage');
                const colorSelect = row.querySelector('.summary-edit-color');

                const name = nameInput?.value?.trim() ?? '';
                const subAppellationId = subAppSelect?.value ?? '';
                const vintageValue = Number(vintageInput?.value ?? '');
                const color = colorSelect?.value ?? '';

                if (!name) {
                    showMessage('Wine name is required.', 'error');
                    return;
                }

                if (!subAppellationId) {
                    showMessage('Select a sub-appellation for the wine.', 'error');
                    return;
                }

                if (!Number.isInteger(vintageValue)) {
                    showMessage('Enter a valid vintage year.', 'error');
                    return;
                }

                if (!color) {
                    showMessage('Choose a wine color.', 'error');
                    return;
                }

                const payload = {
                    wineName: name,
                    subAppellationId,
                    vintage: vintageValue,
                    color
                };

                const groupId = row.dataset.groupId;
                if (!groupId) {
                    showMessage('Unable to determine the selected wine group.', 'error');
                    return;
                }

                try {
                    setSummaryRowLoading(row, true);
                    const response = await sendJson(`/wine-manager/groups/${groupId}`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });

                    const summary = normalizeSummary(response?.group ?? response?.Group);
                    if (!summary) {
                        showMessage('Wine group updated, but it could not be displayed.', 'warning');
                        cancelSummaryEdit(row);
                        return;
                    }

                    applySummaryToRow(row, summary);
                    row.classList.remove('editing');
                    if (selectedRow === row) {
                        selectedSummary = summary;
                    }

                    showMessage('Wine group updated.', 'success');
                    await renderDetails(response, selectedRow === row);
                } catch (error) {
                    showMessage(error.message, 'error');
                } finally {
                    setSummaryRowLoading(row, false);
                }
            }

            async function handleSummaryDelete(row) {
                if (loading) {
                    return;
                }

                const groupId = row.dataset.groupId;
                if (!groupId) {
                    return;
                }

                const confirmed = window.confirm('Delete this wine group and all of its bottles?');
                if (!confirmed) {
                    return;
                }

                try {
                    setSummaryRowLoading(row, true);
                    await sendJson(`/wine-manager/groups/${groupId}`, { method: 'DELETE' });

                    if (selectedRow === row) {
                        selectedGroupId = null;
                        selectedSummary = null;
                        selectedRow = null;
                        detailsTitle.textContent = 'Bottle Details';
                        detailsSubtitle.textContent = 'Select a wine group to view individual bottles.';
                        detailAddRow.hidden = true;
                        emptyRow.hidden = false;
                        detailsBody.querySelectorAll('.detail-row').forEach(r => r.remove());
                    }

                    row.remove();
                    showMessage('Wine group deleted.', 'success');
                } catch (error) {
                    showMessage(error.message, 'error');
                } finally {
                    setSummaryRowLoading(row, false);
                }
            }

            function extractSummaryFromRow(row) {
                return {
                    wineVintageId: row.dataset.groupId ?? '',
                    wineId: row.dataset.wineId ?? '',
                    wineName: row.querySelector('.summary-wine')?.textContent?.trim() ?? '',
                    subAppellation: row.querySelector('.summary-appellation')?.textContent?.trim() ?? '',
                    subAppellationId: row.dataset.subAppellationId ?? '',
                    appellationId: row.dataset.appellationId ?? '',
                    vintage: Number(row.querySelector('.summary-vintage')?.textContent ?? '') || null,
                    bottleCount: Number(row.querySelector('.summary-bottles')?.textContent ?? '') || 0,
                    color: row.querySelector('.summary-color')?.textContent?.trim() ?? '',
                    statusLabel: row.querySelector('[data-field="status"]')?.textContent?.trim() ?? '',
                    statusCssClass: row.querySelector('[data-field="status"]')?.className?.replace('status-pill', '').trim() ?? '',
                    averageScore: (() => {
                        const value = row.querySelector('[data-field="score"]')?.textContent?.trim() ?? '';
                        const parsed = Number(value);
                        return Number.isFinite(parsed) ? parsed : null;
                    })()
                };
            }

            async function handleRowSelection(row, options = {}) {
                if (loading && !options.force) {
                    return;
                }

                const groupId = row.dataset.groupId;
                if (!groupId) {
                    return;
                }

                if (selectedGroupId === groupId && !options.force) {
                    return;
                }

                if (selectedRow && selectedRow !== row) {
                    selectedRow.classList.remove('selected');
                    selectedRow.setAttribute('aria-expanded', 'false');
                }

                selectedRow = row;
                selectedGroupId = groupId;
                row.classList.add('selected');
                row.setAttribute('aria-expanded', 'true');

                if (options.response) {
                    await renderDetails(options.response, true);
                    return;
                }

                await loadDetails(groupId, false);
            }

            async function loadDetails(groupId, updateRow) {
                showMessage('Loading bottle details…', 'info');
                emptyRow.hidden = false;
                detailsBody.querySelectorAll('.detail-row').forEach(r => r.remove());

                try {
                    setLoading(true);
                    const response = await sendJson(`/wine-manager/bottles/${groupId}`, { method: 'GET' });
                    await renderDetails(response, updateRow);
                    showMessage('', 'info');
                } catch (error) {
                    showMessage(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            }

            async function renderDetails(data, shouldUpdateRow) {
                await referenceDataPromise;

                const rawSummary = data?.group ?? data?.Group ?? null;
                const summary = normalizeSummary(rawSummary);
                const rawDetails = Array.isArray(data?.details)
                    ? data.details
                    : Array.isArray(data?.Details)
                        ? data.Details
                        : [];
                const details = rawDetails.map(normalizeDetail).filter(Boolean);

                selectedSummary = summary;

                if (summary) {
                    detailsTitle.textContent = `${summary.wineName ?? ''} • ${summary.vintage ?? ''}`;
                    detailsSubtitle.textContent = `${summary.bottleCount ?? 0} bottle${summary.bottleCount === 1 ? '' : 's'} · ${summary.statusLabel ?? ''}`;
                    detailAddRow.hidden = false;
                    detailAddPrice.value = '';
                    detailAddIsDrunk.checked = false;
                    if (detailAddLabel) {
                        detailAddLabel.textContent = 'No';
                    }
                    detailAddDrunkAt.value = '';
                    detailAddDrunkAt.setAttribute('disabled', 'disabled');
                    populateLocationSelect(detailAddLocation, '');
                    detailAddButton.disabled = loading;
                } else {
                    detailsTitle.textContent = 'Bottle Details';
                    detailsSubtitle.textContent = 'No bottles remain for the selected group.';
                    detailAddRow.hidden = true;
                }

                detailsBody.querySelectorAll('.detail-row').forEach(r => r.remove());

                if (details.length === 0) {
                    emptyRow.hidden = false;
                } else {
                    emptyRow.hidden = true;
                    details.forEach(detail => {
                        const row = buildDetailRow(detail, summary);
                        detailsBody.appendChild(row);
                    });
                }

                if (shouldUpdateRow) {
                    updateSummaryRow(summary ?? null);
                }
            }

            function updateSummaryRow(summary) {
                if (!selectedGroupId) {
                    return;
                }

                const row = inventoryTable.querySelector(`tr[data-group-id="${selectedGroupId}"]`);
                if (!row) {
                    return;
                }

                if (!summary) {
                    row.remove();
                    selectedRow = null;
                    selectedGroupId = null;
                    return;
                }

                applySummaryToRow(row, summary);
            }

            function buildDetailRow(detail, summary) {
                const row = document.createElement('tr');
                row.className = 'detail-row';
                row.dataset.bottleId = detail.bottleId ?? detail.BottleId ?? '';

                const formattedDate = formatDateTime(detail.drunkAt ?? detail.DrunkAt);
                const isDrunk = Boolean(detail.isDrunk ?? detail.IsDrunk);

                row.innerHTML = `
                    <td></td>
                    <td><input type="number" step="0.01" min="0" class="detail-price" value="${detail.price ?? detail.Price ?? ''}" placeholder="0.00" /></td>
                    <td>
                        <label class="checkbox-row">
                            <input type="checkbox" class="detail-is-drunk" ${isDrunk ? 'checked' : ''} />
                            <span>${isDrunk ? 'Yes' : 'No'}</span>
                        </label>
                    </td>
                    <td><input type="datetime-local" class="detail-drunk-at" value="${formattedDate}" ${isDrunk ? '' : 'disabled'} /></td>
                    <td class="actions">
                        <button type="button" class="save">Save</button>
                        <button type="button" class="secondary delete">Remove</button>
                    </td>`;

                const locationCell = row.children[0];
                const locationSelect = document.createElement('select');
                locationSelect.className = 'detail-location';
                populateLocationSelect(locationSelect, detail.bottleLocationId ?? detail.BottleLocationId ?? '');
                locationCell.appendChild(locationSelect);

                const drunkCheckbox = row.querySelector('.detail-is-drunk');
                const drunkLabel = row.querySelector('.detail-is-drunk')?.nextElementSibling;
                const drunkInput = row.querySelector('.detail-drunk-at');
                const saveButton = row.querySelector('.save');
                const deleteButton = row.querySelector('.delete');

                drunkCheckbox?.addEventListener('change', () => {
                    if (drunkCheckbox.checked) {
                        drunkInput?.removeAttribute('disabled');
                        if (drunkLabel) {
                            drunkLabel.textContent = 'Yes';
                        }
                    } else {
                        drunkInput?.setAttribute('disabled', 'disabled');
                        if (drunkInput) {
                            drunkInput.value = '';
                        }
                        if (drunkLabel) {
                            drunkLabel.textContent = 'No';
                        }
                    }
                });

                saveButton?.addEventListener('click', async () => {
                    if (!selectedSummary || loading) {
                        return;
                    }

                    const payload = {
                        wineVintageId: selectedSummary.wineVintageId,
                        price: parsePrice(row.querySelector('.detail-price')?.value ?? ''),
                        isDrunk: drunkCheckbox?.checked ?? false,
                        drunkAt: parseDateTime(drunkInput?.value ?? ''),
                        bottleLocationId: locationSelect.value || null
                    };

                    try {
                        setRowLoading(row, true);
                        const response = await sendJson(`/wine-manager/bottles/${detail.bottleId ?? detail.BottleId}`, {
                            method: 'PUT',
                            body: JSON.stringify(payload)
                        });
                        await renderDetails(response, true);
                        showMessage('Bottle updated.', 'success');
                    } catch (error) {
                        showMessage(error.message, 'error');
                    } finally {
                        setRowLoading(row, false);
                    }
                });

                deleteButton?.addEventListener('click', async () => {
                    if (!selectedSummary || loading) {
                        return;
                    }

                    const confirmed = window.confirm('Remove this bottle from the inventory?');
                    if (!confirmed) {
                        return;
                    }

                    try {
                        setRowLoading(row, true);
                        const response = await sendJson(`/wine-manager/bottles/${detail.bottleId ?? detail.BottleId}`, {
                            method: 'DELETE'
                        });
                        await renderDetails(response, true);
                        showMessage('Bottle removed.', 'success');
                    } catch (error) {
                        showMessage(error.message, 'error');
                    } finally {
                        setRowLoading(row, false);
                    }
                });

                return row;
            }

            async function handleAddBottle() {
                if (!selectedSummary || loading) {
                    return;
                }

                const payload = {
                    wineVintageId: selectedSummary.wineVintageId,
                    price: parsePrice(detailAddPrice.value),
                    isDrunk: detailAddIsDrunk.checked,
                    drunkAt: parseDateTime(detailAddDrunkAt.value),
                    bottleLocationId: detailAddLocation.value || null
                };

                try {
                    setLoading(true);
                    const response = await sendJson('/wine-manager/bottles', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });

                    detailAddPrice.value = '';
                    detailAddIsDrunk.checked = false;
                    if (detailAddLabel) {
                        detailAddLabel.textContent = 'No';
                    }
                    detailAddDrunkAt.value = '';
                    detailAddDrunkAt.setAttribute('disabled', 'disabled');
                    detailAddLocation.value = '';

                    await renderDetails(response, true);
                    showMessage('Bottle added successfully.', 'success');
                } catch (error) {
                    showMessage(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            }

            function setLoading(state) {
                loading = state;
                if (summaryAddButton) {
                    summaryAddButton.disabled = state;
                }
                if (detailAddButton) {
                    detailAddButton.disabled = state || detailAddRow.hidden;
                }
            }

            function setSummaryRowLoading(row, state) {
                if (state) {
                    row.classList.add('loading');
                } else {
                    row.classList.remove('loading');
                }

                row.querySelectorAll('input, select, button').forEach(element => {
                    element.disabled = state;
                });
            }

            function setRowLoading(row, state) {
                if (state) {
                    row.classList.add('loading');
                } else {
                    row.classList.remove('loading');
                }

                row.querySelectorAll('input, button, select').forEach(element => {
                    element.disabled = state;
                });
            }

            function parsePrice(value) {
                if (!value) {
                    return null;
                }

                const parsed = Number.parseFloat(value);
                return Number.isFinite(parsed) ? parsed : null;
            }

            function parseDateTime(value) {
                if (!value) {
                    return null;
                }

                const date = new Date(value);
                return Number.isNaN(date.getTime()) ? null : date.toISOString();
            }

            function formatDateTime(value) {
                if (!value) {
                    return '';
                }

                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return '';
                }

                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            function shortId(id) {
                if (!id) {
                    return '';
                }

                const value = String(id);
                return value.length > 8 ? `${value.substring(0, 8)}…` : value;
            }

            function showMessage(text, state) {
                if (!text) {
                    messageBanner.style.display = 'none';
                    messageBanner.textContent = '';
                    return;
                }

                messageBanner.dataset.state = state ?? 'info';
                messageBanner.textContent = text;
                messageBanner.style.display = 'block';
            }

            function buildAppellationDisplay(summary) {
                const subApp = summary?.subAppellation ?? summary?.SubAppellation;
                const appellation = summary?.appellation ?? summary?.Appellation;

                if (subApp && appellation && !equalsIgnoreCase(subApp, appellation)) {
                    return `${subApp} (${appellation})`;
                }

                if (subApp) {
                    return subApp;
                }

                if (appellation) {
                    return appellation;
                }

                return '—';
            }

            function equalsIgnoreCase(a, b) {
                if (a == null || b == null) {
                    return false;
                }

                return String(a).toLowerCase() === String(b).toLowerCase();
            }

            function pick(obj, keys) {
                for (const key of keys) {
                    if (obj && obj[key] !== undefined && obj[key] !== null) {
                        return obj[key];
                    }
                }

                return undefined;
            }

            function normalizeSummary(raw) {
                if (!raw) {
                    return null;
                }

                return {
                    wineVintageId: pick(raw, ['wineVintageId', 'WineVintageId']),
                    wineId: pick(raw, ['wineId', 'WineId']),
                    wineName: pick(raw, ['wineName', 'WineName']) ?? '',
                    subAppellation: pick(raw, ['subAppellation', 'SubAppellation']),
                    appellation: pick(raw, ['appellation', 'Appellation']),
                    subAppellationId: pick(raw, ['subAppellationId', 'SubAppellationId']),
                    appellationId: pick(raw, ['appellationId', 'AppellationId']),
                    vintage: pick(raw, ['vintage', 'Vintage']),
                    bottleCount: Number(pick(raw, ['bottleCount', 'BottleCount']) ?? 0),
                    statusLabel: pick(raw, ['statusLabel', 'StatusLabel']) ?? '',
                    statusCssClass: pick(raw, ['statusCssClass', 'StatusCssClass']) ?? '',
                    averageScore: pick(raw, ['averageScore', 'AverageScore']),
                    color: pick(raw, ['color', 'Color']) ?? ''
                };
            }

            function normalizeDetail(raw) {
                if (!raw) {
                    return null;
                }

                return {
                    bottleId: pick(raw, ['bottleId', 'BottleId']),
                    price: pick(raw, ['price', 'Price']),
                    isDrunk: Boolean(pick(raw, ['isDrunk', 'IsDrunk'])),
                    drunkAt: pick(raw, ['drunkAt', 'DrunkAt']),
                    bottleLocationId: pick(raw, ['bottleLocationId', 'BottleLocationId']),
                    bottleLocation: pick(raw, ['bottleLocation', 'BottleLocation']),
                    vintage: pick(raw, ['vintage', 'Vintage']),
                    wineName: pick(raw, ['wineName', 'WineName'])
                };
            }

            async function sendJson(url, options) {
                const requestInit = {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    ...options
                };

                const response = await fetch(url, requestInit);
                if (!response.ok) {
                    let message = `${response.status} ${response.statusText}`;
                    try {
                        const problem = await response.json();
                        if (typeof problem === 'string') {
                            message = problem;
                        } else if (problem?.title) {
                            message = problem.title;
                        } else if (problem?.message) {
                            message = problem.message;
                        }
                    } catch {
                        const text = await response.text();
                        if (text) {
                            message = text;
                        }
                    }

                    throw new Error(message);
                }

                if (response.status === 204) {
                    return {};
                }

                return response.json();
            }

            function escapeHtml(value) {
                if (value == null) {
                    return '';
                }

                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }
        })();
    </script>

</body>
</html>
