@model AllMCPSolution.Models.AcceptDeliveriesModalViewModel?
@using System
@using System.Collections.Generic
@using System.Globalization
@using AllMCPSolution.Models
@{
    var modalModel = Model ?? AcceptDeliveriesModalViewModel.Empty;
    var pendingBottles = modalModel.PendingBottles ?? Array.Empty<PendingBottleOption>();
    var locationOptions = modalModel.Locations ?? Array.Empty<BottleLocationOption>();
    var hasPending = pendingBottles.Count > 0;
    var hasLocations = locationOptions.Count > 0;

    string BuildLocationLabel(BottleLocationOption option)
    {
        var name = string.IsNullOrWhiteSpace(option.Name) ? option.Id.ToString() : option.Name;
        if (option.Capacity.HasValue)
        {
            var capacity = option.Capacity.Value.ToString("N0", CultureInfo.CurrentCulture);
            return $"{name} ({capacity} capacity)";
        }

        return name;
    }

    string BuildWineLabel(PendingBottleOption option)
    {
        var wineName = string.IsNullOrWhiteSpace(option.WineName) ? "Unnamed wine" : option.WineName.Trim();
        return option.Vintage > 0 ? $"{option.Vintage} {wineName}" : wineName;
    }

    string BuildRegionLabel(PendingBottleOption option)
    {
        var parts = new List<string>();
        var seen = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

        void TryAdd(string? value)
        {
            if (!string.IsNullOrWhiteSpace(value) && seen.Add(value))
            {
                parts.Add(value);
            }
        }

        TryAdd(option.SubAppellation);
        TryAdd(option.Appellation);
        TryAdd(option.Region);

        return parts.Count > 0 ? string.Join(" · ", parts) : string.Empty;
    }

    var overlayAttributes = new Dictionary<string, string?>
    {
        ["hidden"] = null,
        ["aria-hidden"] = "true",
        ["data-accept-deliveries-overlay"] = "true"
    };

    var dialogAttributes = new Dictionary<string, string?>
    {
        ["aria-labelledby"] = "accept-deliveries-title",
        ["data-accept-deliveries-modal"] = "true"
    };

    var closeAttributes = new Dictionary<string, string?>
    {
        ["data-accept-deliveries-close"] = null
    };

    var modal = new WineSurferModalShell
    {
        BackdropId = "accept-deliveries-overlay",
        BackdropCssClass = "wine-surfer-modal-backdrop accept-deliveries-overlay",
        BackdropAttributes = overlayAttributes,
        DialogId = "accept-deliveries-modal",
        DialogCssClass = "wine-surfer-modal accept-deliveries-modal",
        DialogAttributes = dialogAttributes,
        HeaderCssClass = "wine-surfer-modal__header accept-deliveries-header",
        Title = "Accept deliveries",
        TitleCssClass = "wine-surfer-modal__title accept-deliveries-title",
        TitleElementId = "accept-deliveries-title",
        BodyCssClass = "wine-surfer-modal__body accept-deliveries-body",
        CloseButtonCssClass = "wine-surfer-modal__close accept-deliveries-close",
        CloseButtonLabel = "Close accept deliveries dialog",
        CloseButtonAttributes = closeAttributes,
        BodyContent = @<section class="accept-deliveries" data-accept-deliveries-root data-has-pending="@(hasPending ? "true" : "false")" data-has-locations="@(hasLocations ? "true" : "false")">
            <form class="accept-deliveries-form" data-accept-deliveries-form>
                <fieldset class="accept-deliveries-fieldset">
                    <legend class="accept-deliveries-legend">Pending bottles</legend>
                    <p class="accept-deliveries-empty-message" data-accept-deliveries-empty @(hasPending ? "hidden" : null)>
                        You're all caught up—no pending deliveries.
                    </p>
                    @if (hasPending)
                    {
                        <ul class="accept-deliveries-list" data-accept-deliveries-list>
                            @foreach (var bottle in pendingBottles)
                            {
                                var wineLabel = BuildWineLabel(bottle);
                                var regionLabel = BuildRegionLabel(bottle);
                                var locationLabel = string.IsNullOrWhiteSpace(bottle.LocationName)
                                    ? string.Empty
                                    : $"Current location: {bottle.LocationName}";
                                <li class="accept-deliveries-item">
                                    <label class="accept-deliveries-option">
                                        <input type="checkbox"
                                               class="accept-deliveries-checkbox"
                                               value="@bottle.BottleId"
                                               data-accept-deliveries-bottle-id="@bottle.BottleId"
                                               data-accept-deliveries-wine-vintage-id="@bottle.WineVintageId" />
                                        <span class="accept-deliveries-option-text">
                                            <span class="accept-deliveries-option-wine">@wineLabel</span>
                                            @if (!string.IsNullOrEmpty(regionLabel))
                                            {
                                                <span class="accept-deliveries-option-meta">@regionLabel</span>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(locationLabel))
                                            {
                                                <span class="accept-deliveries-option-location">@locationLabel</span>
                                            }
                                        </span>
                                    </label>
                                </li>
                            }
                        </ul>
                    }
                </fieldset>
                <label class="accept-deliveries-field">
                    <span class="accept-deliveries-label">Store bottles in</span>
                    <select class="accept-deliveries-location"
                            data-accept-deliveries-location
                            @(hasLocations ? null : "disabled")>
                        <option value="">Choose a location</option>
                        @foreach (var option in locationOptions)
                        {
                            <option value="@option.Id">@BuildLocationLabel(option)</option>
                        }
                    </select>
                </label>
                @if (!hasLocations)
                {
                    <p class="accept-deliveries-hint">Add a storage location to accept pending deliveries.</p>
                }
                <p class="accept-deliveries-error"
                   data-accept-deliveries-error
                   role="alert"
                   aria-live="polite"
                   hidden></p>
                <div class="accept-deliveries-actions">
                    <button type="button"
                            class="wine-surfer-button wine-surfer-button--ghost"
                            data-accept-deliveries-cancel>Cancel</button>
                    <button type="submit"
                            class="wine-surfer-button wine-surfer-button--orange"
                            data-accept-deliveries-submit
                            @(hasPending && hasLocations ? null : "disabled")>Accept delivery</button>
                </div>
            </form>
        </section>
    };
}
@await Html.PartialAsync("_WineSurferModalShell", modal)
<script src="/js/accept-deliveries-modal.js" defer></script>
