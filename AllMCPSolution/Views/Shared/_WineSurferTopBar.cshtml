@using System.Collections.Generic
@using System.Linq
@using System.Security.Claims
@using System.Text.Json
@using Microsoft.AspNetCore.Mvc.Rendering
@using AllMCPSolution.Controllers
@using AllMCPSolution.Models
@model WineSurferTopBarModel?

@{ 
    var navItems = new (string Href, string Label)[]
    {
        ("/wine-surfer", "Home"),
        ("/wine-surfer/sisterhoods", "Sisterhoods"),
        ("/wine-manager", "Wine Inventory")
    };

    var rawPath = Model?.CurrentPath;
    var currentPath = string.IsNullOrWhiteSpace(rawPath)
        ? string.Empty
        : rawPath!.TrimEnd('/');

    if (string.IsNullOrEmpty(currentPath) && !string.IsNullOrEmpty(rawPath))
    {
        currentPath = "/";
    }

    var visibleNavItems = navItems
        .Where(item => !string.Equals(item.Href, currentPath, StringComparison.OrdinalIgnoreCase))
        .ToList();

    var userDisplayName = User?.Identity?.IsAuthenticated == true
        ? User.Identity?.Name ?? string.Empty
        : string.Empty;

    if (User?.Identity?.IsAuthenticated == true && string.IsNullOrWhiteSpace(userDisplayName))
    {
        userDisplayName = User.FindFirst(ClaimTypes.Email)?.Value
            ?? User.FindFirst("email")?.Value
            ?? string.Empty;
    }

    var sections = (Model?.Sections ?? Array.Empty<WineSurferTopBarNotificationSection>())
        .Where(section => section is not null)
        .ToList();

    var dismissedMap = Model?.DismissedNotificationStamps ?? WineSurferTopBarModel.EmptyDismissedNotificationSet;
    var dismissedStampSet = new HashSet<string>(StringComparer.Ordinal);
    foreach (var entry in dismissedMap)
    {
        if (entry.Value is null)
        {
            continue;
        }

        foreach (var stamp in entry.Value)
        {
            if (!string.IsNullOrWhiteSpace(stamp))
            {
                dismissedStampSet.Add(stamp);
            }
        }
    }

    var allNotifications = sections
        .SelectMany(section => section.Notifications ?? Array.Empty<WineSurferTopBarNotification>())
        .Where(notification => notification is not null)
        .ToList();

    var totalNotificationCount = allNotifications
        .Count(notification => !dismissedStampSet.Contains(notification.Stamp));

    var panelHeading = string.IsNullOrWhiteSpace(Model?.PanelHeading)
        ? WineSurferTopBarModel.DefaultPanelHeading
        : Model!.PanelHeading;
    var panelAriaLabel = string.IsNullOrWhiteSpace(Model?.PanelAriaLabel)
        ? panelHeading
        : Model!.PanelAriaLabel;
    var footerLinkItems = (Model?.FooterLinks ?? Array.Empty<WineSurferTopBarLink>())
        .Where(link => link is not null && !string.IsNullOrWhiteSpace(link.Href) && !string.IsNullOrWhiteSpace(link.Label))
        .ToList();
    var notificationHeadingId = "notificationPanelHeading";

    var avatarLetter = "?";

    if (!string.IsNullOrWhiteSpace(userDisplayName))
    {
        var trimmedUserName = userDisplayName.Trim();
        if (!string.IsNullOrEmpty(trimmedUserName))
        {
            avatarLetter = trimmedUserName[..1].ToUpperInvariant();
        }
    }

    var avatarAccountLabel = string.IsNullOrWhiteSpace(userDisplayName)
        ? "Guest account"
        : $"{userDisplayName}'s account";

    var notificationSummary = totalNotificationCount switch
    {
        0 => "No notifications",
        1 => "1 notification",
        _ => $"{totalNotificationCount} notifications"
    };

    var avatarButtonLabel = string.IsNullOrWhiteSpace(avatarAccountLabel)
        ? $"{notificationSummary}."
        : $"{avatarAccountLabel}. {notificationSummary}.";

    var userIdClaim = User?.FindFirstValue(ClaimTypes.NameIdentifier);
    var notificationStorageUserKey = string.IsNullOrWhiteSpace(userIdClaim) ? "guest" : userIdClaim!;

    var returnUrl = string.IsNullOrWhiteSpace(rawPath) ? "/wine-surfer" : rawPath!;
    if (!string.IsNullOrEmpty(returnUrl) && !returnUrl.StartsWith('/'))
    {
        returnUrl = "/wine-surfer";
    }

    var loginUrl = Url.Action("Login", "Account", new { returnUrl });
    var registerUrl = Url.Action("Register", "Account", new { returnUrl });
    var changePasswordUrl = Url.Action("ChangePassword", "Account");

    var dismissalEndpoint = Url.Action("Dismiss", "WineSurferNotifications") ?? "/wine-surfer/notifications/dismiss";
    var dismissedStampJson = JsonSerializer.Serialize(dismissedStampSet.ToArray());
    var dismissalEndpointJson = JsonSerializer.Serialize(dismissalEndpoint);
    var isAuthenticated = User?.Identity?.IsAuthenticated == true;
    var isAuthenticatedJson = JsonSerializer.Serialize(isAuthenticated);
}

<header class="top-bar">
    <a class="brand" href="/wine-surfer" aria-label="Wine Surfer home">
        <img src="/assets/logo.png" alt="Wine Surfer" style="height:32px;width:auto;display:block;" />
    </a>
    <div class="top-bar-page-title" data-top-bar-page-title aria-hidden="true" hidden></div>
    <div class="top-bar-actions">
        <div class="notification-shell">
            <button
                id="notificationToggle"
                class="top-bar-avatar"
                type="button"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="notificationPanel"
                aria-label="@avatarButtonLabel"
                data-account-label="@avatarAccountLabel"
                data-user-id="@notificationStorageUserKey"
                data-is-authenticated="@(isAuthenticated ? "true" : "false")">
                <span aria-hidden="true">@avatarLetter</span>
            </button>
            @if (totalNotificationCount > 0)
            {
                <span class="notification-badge" aria-hidden="true">@totalNotificationCount</span>
            }
            <div
                id="notificationPanel"
                class="notification-panel"
                role="region"
                aria-hidden="true"
                aria-labelledby="@notificationHeadingId"
                aria-label="@panelAriaLabel">
                <p id="@notificationHeadingId" class="notification-heading">@panelHeading</p>
                @if (sections.Count > 0)
                    {
                        foreach (var sec in sections)
                        {
                            var notifications = (sec.Notifications ?? Array.Empty<WineSurferTopBarNotification>())
                                .Where(notification => notification is not null)
                                .ToList();

                            var sectionHasVisible = notifications.Any(notification => !dismissedStampSet.Contains(notification.Stamp));

                            <div
                                class="notification-section"
                                data-section-key="@sec.Key"
                                aria-label="@(sec.AriaLabel ?? sec.Heading)"
                                @(sectionHasVisible ? string.Empty : " hidden")>
                                
                                <p class="notification-subheading">@sec.Heading</p>
                                
                                <ul class="notification-list">
                                    @foreach (var notification in notifications)
                                    {
                                        var isDismissed = dismissedStampSet.Contains(notification.Stamp);
                                        var url = string.IsNullOrWhiteSpace(notification.Url) ? "#" : notification.Url!;
                                        var disableLink = string.IsNullOrWhiteSpace(notification.Url);
                                        var bodySegments = (notification.Body ?? Array.Empty<WineSurferTopBarTextSegment>())
                                            .Where(segment => segment is not null)
                                            .ToList();
                                        var metaSegments = (notification.Meta ?? Array.Empty<WineSurferTopBarTextSegment>())
                                            .Where(segment => segment is not null)
                                            .ToList();
                                        var occurredLocal = notification.OccurredAtUtc?.ToLocalTime();
                                        var occurredLabel = occurredLocal?.ToString("g");
                                        var dismissLabel = string.IsNullOrWhiteSpace(notification.DismissLabel)
                                            ? $"Dismiss notification for {notification.Title}"
                                            : notification.DismissLabel!;

                                        <li
                                            class="notification-item"
                                            data-notification-stamp="@notification.Stamp"
                                            data-notification-category="@notification.Category"
                                            data-section-key="@sec.Key"
                                            @(isDismissed ? " hidden aria-hidden=\"true\"" : string.Empty)>
                                            
                                            <a
                                                class="notification-link"
                                                href="@url"
                                                @(disableLink ? " aria-disabled=\"true\" tabindex=\"-1\"" : string.Empty)>
                                                
                                                <span class="notification-title">@notification.Title</span>

                                                @if (bodySegments.Count > 0)
                                                {
                                                    <span class="notification-meta">
                                                        @foreach (var segment in bodySegments)
                                                        {
                                                            if (segment.Emphasize)
                                                            {
                                                                <strong>@segment.Text</strong>
                                                            }
                                                            else
                                                            {
                                                                @segment.Text
                                                            }
                                                        }
                                                    </span>
                                                }

                                                @if (metaSegments.Count > 0 || occurredLabel is not null)
                                                {
                                                    <span class="notification-meta notification-meta-secondary">
                                                        @{
                                                            var hasMetaText = false;
                                                            foreach (var segment in metaSegments)
                                                            {
                                                                hasMetaText = true;
                                                                if (segment.Emphasize)
                                                                {
                                                                    <strong>@segment.Text</strong>
                                                                }
                                                                else
                                                                {
                                                                    @segment.Text
                                                                }
                                                            }

                                                            if (occurredLabel is not null)
                                                            {
                                                                if (hasMetaText)
                                                                {
                                                                    @: Â· 
                                                                }

                                                                @occurredLabel
                                                            }
                                                        }
                                                    </span>
                                                }

                                                @if (!string.IsNullOrWhiteSpace(notification.Tag))
                                                {
                                                    <span class="notification-tag">@notification.Tag</span>
                                                }
                                            </a>

                                            <button
                                                type="button"
                                                class="notification-dismiss"
                                                data-notification-stamp="@notification.Stamp"
                                                data-notification-category="@notification.Category"
                                                aria-label="@dismissLabel">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                    }

                <p class="notification-empty"@(totalNotificationCount > 0 ? " hidden" : string.Empty)>You're all caught up. No notifications right now.</p>
                @if (footerLinkItems.Count > 0)
                {
                    <div class="notification-footer">
                        @foreach (var link in footerLinkItems)
                        {
                            <a href="@link.Href">@link.Label</a>
                        }
                    </div>
                }
            </div>
        </div>
        <button id="menuToggle" class="burger" type="button" aria-expanded="false" aria-controls="menuPanel">
            <span></span>
        </button>
    </div>
    <nav id="menuPanel" class="menu-panel" aria-hidden="true">
        @if (visibleNavItems.Count > 0)
        {
            <div class="menu-links">
                @foreach (var item in visibleNavItems)
                {
                    <a href="@item.Href">@item.Label</a>
                }
            </div>
            <div class="menu-divider" aria-hidden="true"></div>
        }
        <div class="menu-user">
            @if (User?.Identity?.IsAuthenticated == true)
            {
                <span class="menu-user-label">Signed in as</span>
                <span class="menu-user-name">@(string.IsNullOrWhiteSpace(userDisplayName) ? "Account" : userDisplayName)</span>
                <div class="menu-auth-options">
                    @if (!string.IsNullOrEmpty(changePasswordUrl))
                    {
                        <a class="auth-toggle" href="@changePasswordUrl">Change password</a>
                    }
                    @using (Html.BeginForm("Logout", "Account", FormMethod.Post, new { @class = "auth-form" }))
                    {
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="returnUrl" value="@returnUrl" />
                        <button class="auth-toggle" type="submit" data-auth-state="logout">Sign out</button>
                    }
                </div>
            }
            else
            {
                <span class="menu-user-label">Account</span>
                <div class="menu-auth-options">
                    @if (!string.IsNullOrEmpty(loginUrl))
                    {
                        <a class="auth-toggle" href="@loginUrl">Sign in with email</a>
                    }
                    @if (!string.IsNullOrEmpty(registerUrl))
                    {
                        <a class="auth-toggle" href="@registerUrl">Create an account</a>
                    }
                </div>
            }
        </div>
    </nav>
</header>
<script>
    (() => {
        const dismissalEndpoint = @Html.Raw(dismissalEndpointJson);
        const isAuthenticatedUser = @Html.Raw(isAuthenticatedJson);
        const initialServerDismissed = new Set(@Html.Raw(dismissedStampJson));

        const toggle = document.getElementById('menuToggle');
        const panel = document.getElementById('menuPanel');
        const notificationToggle = document.getElementById('notificationToggle');
        const notificationPanel = document.getElementById('notificationPanel');
        const notificationBadge = document.querySelector('.notification-badge');

        const closeMenu = () => {
            if (!toggle || !panel) {
                return;
            }

            toggle.classList.remove('active');
            toggle.setAttribute('aria-expanded', 'false');
            panel.classList.remove('open');
            panel.setAttribute('aria-hidden', 'true');
        };

        const closeNotifications = () => {
            if (!notificationToggle || !notificationPanel) {
                return;
            }

            notificationToggle.classList.remove('active');
            notificationToggle.setAttribute('aria-expanded', 'false');
            notificationPanel.classList.remove('open');
            notificationPanel.setAttribute('aria-hidden', 'true');
        };

        const storageKeyBase = notificationToggle?.dataset.userId ?? 'guest';
        const dismissedStorageKey = `wineSurfer.notifications.dismissed.${storageKeyBase}`;

        const loadDismissedStamps = () => {
            if (typeof window === 'undefined' || !window.localStorage) {
                return [];
            }

            try {
                const raw = window.localStorage.getItem(dismissedStorageKey);
                if (!raw) {
                    return [];
                }

                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed)) {
                    return [];
                }

                return parsed.filter(item => typeof item === 'string');
            } catch {
                return [];
            }
        };

        const dismissedStamps = new Set([...initialServerDismissed, ...loadDismissedStamps()]);

        const persistDismissedStamps = (shouldPersist) => {
            if (typeof window === 'undefined' || !window.localStorage) {
                return;
            }

            try {
                if (!shouldPersist || dismissedStamps.size === 0) {
                    window.localStorage.removeItem(dismissedStorageKey);
                    return;
                }

                window.localStorage.setItem(dismissedStorageKey, JSON.stringify(Array.from(dismissedStamps)));
            } catch {
                // Ignore storage errors
            }
        };

        const updateAvatarLabel = (visibleCount) => {
            if (!notificationToggle) {
                return;
            }

            const accountLabel = notificationToggle.dataset.accountLabel ?? '';
            let summary;
            if (visibleCount === 0) {
                summary = 'No notifications';
            } else if (visibleCount === 1) {
                summary = '1 notification';
            } else {
                summary = `${visibleCount} notifications`;
            }

            const finalLabel = accountLabel ? `${accountLabel}. ${summary}.` : `${summary}.`;
            notificationToggle.setAttribute('aria-label', finalLabel);
        };

        const applyDismissedNotifications = () => {
            if (!notificationPanel) {
                updateAvatarLabel(0);
                return;
            }

            let visibleCount = 0;

            const sections = Array.from(notificationPanel.querySelectorAll('.notification-section'));
            sections.forEach(section => {
                let sectionVisible = 0;
                const items = Array.from(section.querySelectorAll('.notification-item'));
                items.forEach(item => {
                    const stamp = item.dataset.notificationStamp;
                    if (!stamp) {
                        item.hidden = false;
                        item.setAttribute('aria-hidden', 'false');
                        sectionVisible += 1;
                        visibleCount += 1;
                        return;
                    }

                    const isDismissed = dismissedStamps.has(stamp);
                    item.hidden = isDismissed;
                    item.setAttribute('aria-hidden', String(isDismissed));

                    if (!isDismissed) {
                        sectionVisible += 1;
                        visibleCount += 1;
                    }
                });

                section.toggleAttribute('hidden', sectionVisible === 0);
            });

            const notificationEmpty = notificationPanel.querySelector('.notification-empty');
            if (notificationEmpty) {
                notificationEmpty.toggleAttribute('hidden', visibleCount > 0);
            }

            if (notificationBadge) {
                if (visibleCount > 0) {
                    notificationBadge.textContent = String(visibleCount);
                    notificationBadge.removeAttribute('hidden');
                    notificationBadge.setAttribute('aria-hidden', 'false');
                    notificationBadge.style.removeProperty('display');
                } else {
                    notificationBadge.textContent = '';
                    notificationBadge.setAttribute('hidden', '');
                    notificationBadge.setAttribute('aria-hidden', 'true');
                    notificationBadge.style.display = 'none';
                }
            }

            updateAvatarLabel(visibleCount);
        };

        const dismissNotification = async (button) => {
            const item = button.closest('.notification-item');
            if (!item) {
                return;
            }

            const stamp = item.dataset.notificationStamp;
            const category = item.dataset.notificationCategory;

            if (!stamp || !category) {
                return;
            }

            if (!isAuthenticatedUser || !dismissalEndpoint) {
                dismissedStamps.add(stamp);
                persistDismissedStamps(true);
                applyDismissedNotifications();
                return;
            }

            dismissedStamps.add(stamp);
            applyDismissedNotifications();

            try {
                const response = await fetch(dismissalEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ category, stamp })
                });

                if (response.ok) {
                    const payload = await response.json();
                    const dismissed = payload?.dismissedStamps;
                    if (dismissed && typeof dismissed === 'object') {
                        dismissedStamps.clear();
                        Object.values(dismissed).forEach(value => {
                            if (Array.isArray(value)) {
                                value.forEach(entry => {
                                    if (typeof entry === 'string') {
                                        dismissedStamps.add(entry);
                                    }
                                });
                            }
                        });
                        persistDismissedStamps(false);
                    } else {
                        persistDismissedStamps(true);
                    }
                } else if (response.status === 401 || response.status === 403) {
                    dismissedStamps.delete(stamp);
                    persistDismissedStamps(true);
                } else {
                    persistDismissedStamps(true);
                }
            } catch {
                persistDismissedStamps(true);
            } finally {
                applyDismissedNotifications();
            }
        };

        if (toggle && panel) {
            toggle.addEventListener('click', () => {
                const isOpen = toggle.classList.toggle('active');
                toggle.setAttribute('aria-expanded', String(isOpen));
                panel.classList.toggle('open', isOpen);
                panel.setAttribute('aria-hidden', String(!isOpen));

                if (isOpen) {
                    closeNotifications();
                }
            });

            panel.querySelectorAll('a, button').forEach(element => {
                element.addEventListener('click', () => {
                    closeMenu();
                });
            });
        }

        if (notificationToggle && notificationPanel) {
            notificationToggle.addEventListener('click', () => {
                const isOpen = notificationToggle.classList.toggle('active');
                notificationToggle.setAttribute('aria-expanded', String(isOpen));
                notificationPanel.classList.toggle('open', isOpen);
                notificationPanel.setAttribute('aria-hidden', String(!isOpen));

                if (isOpen) {
                    closeMenu();
                }
            });

            notificationPanel.querySelectorAll('a, button:not(.notification-dismiss)').forEach(element => {
                element.addEventListener('click', () => {
                    closeNotifications();
                });
            });

            notificationPanel.querySelectorAll('.notification-dismiss').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation();
                    event.preventDefault();
                    (async () => {
                        await dismissNotification(button);
                    })();
                });
            });

            applyDismissedNotifications();
        } else {
            updateAvatarLabel(0);
        }

        document.addEventListener('click', (event) => {
            const target = event.target;
            if (!(target instanceof Node)) {
                return;
            }

            if (panel && toggle && !panel.contains(target) && !toggle.contains(target)) {
                closeMenu();
            }

            if (notificationPanel && notificationToggle && !notificationPanel.contains(target) && !notificationToggle.contains(target)) {
                closeNotifications();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const menuOpen = panel?.classList.contains('open');
                const notificationsOpen = notificationPanel?.classList.contains('open');

                if (menuOpen || notificationsOpen) {
                    event.preventDefault();
                }

                closeMenu();
                closeNotifications();
            }
        });
    })();
</script>
