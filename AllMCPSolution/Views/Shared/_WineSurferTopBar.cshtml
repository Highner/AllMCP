@using System.Linq
@using Microsoft.AspNetCore.Mvc.Rendering
@model string

@{ 
    var navItems = new (string Href, string Label)[]
    {
        ("/wine-surfer", "Home"),
        ("/wine-surfer/sisterhoods", "Sisterhoods"),
        ("/wine-manager", "Wine Inventory")
    };

    var currentPath = string.IsNullOrWhiteSpace(Model)
        ? string.Empty
        : Model.TrimEnd('/');

    if (string.IsNullOrEmpty(currentPath) && !string.IsNullOrEmpty(Model))
    {
        currentPath = "/";
    }

    var visibleNavItems = navItems
        .Where(item => !string.Equals(item.Href, currentPath, System.StringComparison.OrdinalIgnoreCase))
        .ToList();

    var userDisplayName = User?.Identity?.IsAuthenticated == true
        ? User.Identity?.Name ?? string.Empty
        : string.Empty;

    if (User?.Identity?.IsAuthenticated == true && string.IsNullOrWhiteSpace(userDisplayName))
    {
        userDisplayName = User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value
            ?? User.FindFirst("email")?.Value
            ?? string.Empty;
    }

    var avatarLetter = "?";

    if (!string.IsNullOrWhiteSpace(userDisplayName))
    {
        var trimmedUserName = userDisplayName.Trim();
        if (!string.IsNullOrEmpty(trimmedUserName))
        {
            avatarLetter = trimmedUserName.Substring(0, 1).ToUpperInvariant();
        }
    }

    var avatarLabel = string.IsNullOrWhiteSpace(userDisplayName)
        ? "Guest avatar"
        : $"User avatar for {userDisplayName}";

    var returnUrl = string.IsNullOrWhiteSpace(Model) ? "/wine-surfer" : Model;
    if (!returnUrl.StartsWith('/'))
    {
        returnUrl = "/wine-surfer";
    }

    var loginUrl = Url.Action("Login", "Account", new { returnUrl });
    var registerUrl = Url.Action("Register", "Account", new { returnUrl });
    var changePasswordUrl = Url.Action("ChangePassword", "Account");
}

<header class="top-bar">
    <a class="brand" href="/wine-surfer">Wine Surfer</a>
    <div class="top-bar-actions">
        <span class="top-bar-avatar" role="img" aria-label="@avatarLabel">@avatarLetter</span>
        <button id="menuToggle" class="burger" type="button" aria-expanded="false" aria-controls="menuPanel">
            <span></span>
        </button>
    </div>
    <nav id="menuPanel" class="menu-panel" aria-hidden="true">
        @if (visibleNavItems.Count > 0)
        {
            <div class="menu-links">
                @foreach (var item in visibleNavItems)
                {
                    <a href="@item.Href">@item.Label</a>
                }
            </div>
            <div class="menu-divider" aria-hidden="true"></div>
        }
        <div class="menu-user">
            @if (User?.Identity?.IsAuthenticated == true)
            {
                <span class="menu-user-label">Signed in as</span>
                <span class="menu-user-name">@(string.IsNullOrWhiteSpace(userDisplayName) ? "Account" : userDisplayName)</span>
                <div class="menu-auth-options">
                    @if (!string.IsNullOrEmpty(changePasswordUrl))
                    {
                        <a class="auth-toggle" href="@changePasswordUrl">Change password</a>
                    }
                    @using (Html.BeginForm("Logout", "Account", FormMethod.Post, new { @class = "auth-form" }))
                    {
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="returnUrl" value="@returnUrl" />
                        <button class="auth-toggle" type="submit" data-auth-state="logout">Sign out</button>
                    }
                </div>
            }
            else
            {
                <span class="menu-user-label">Account</span>
                <div class="menu-auth-options">
                    @if (!string.IsNullOrEmpty(loginUrl))
                    {
                        <a class="auth-toggle" href="@loginUrl">Sign in with email</a>
                    }
                    @if (!string.IsNullOrEmpty(registerUrl))
                    {
                        <a class="auth-toggle" href="@registerUrl">Create an account</a>
                    }
                </div>
            }
        </div>
    </nav>
</header>
<script>
    (() => {
        const toggle = document.getElementById('menuToggle');
        const panel = document.getElementById('menuPanel');

        if (!toggle || !panel) {
            return;
        }

        const closeMenu = () => {
            toggle.classList.remove('active');
            toggle.setAttribute('aria-expanded', 'false');
            panel.classList.remove('open');
            panel.setAttribute('aria-hidden', 'true');
        };

        toggle.addEventListener('click', () => {
            const isOpen = toggle.classList.toggle('active');
            toggle.setAttribute('aria-expanded', String(isOpen));
            panel.classList.toggle('open', isOpen);
            panel.setAttribute('aria-hidden', String(!isOpen));
        });

        panel.querySelectorAll('a, button').forEach(element => {
            element.addEventListener('click', () => {
                closeMenu();
            });
        });

        document.addEventListener('click', (event) => {
            if (!panel.contains(event.target) && event.target !== toggle) {
                closeMenu();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeMenu();
            }
        });
    })();
</script>
