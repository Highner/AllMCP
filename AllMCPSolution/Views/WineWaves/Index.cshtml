@using System
@using System.Globalization
@using System.Linq
@using System.Text.Json
@using AllMCPSolution.Controllers
@model AllMCPSolution.Controllers.WineWavesViewModel
@{
    Layout = null;
    var currentPath = Context.Request.Path.Value ?? string.Empty;
    var topBarModel = ViewData["WineSurferTopBarModel"] as WineSurferTopBarModel
        ?? WineSurferTopBarModel.Empty(currentPath);
    ViewData["WineSurferPageTitle"] = "Wine Waves";
    var hasDatasets = Model.Datasets.Any();
    var hasInventory = Model.Inventory.Any();
    var deleteWavesDisabled = !hasDatasets;
    var deleteWavesDisabledAttribute = deleteWavesDisabled ? "disabled" : null;
    var deleteWavesAriaDisabled = deleteWavesDisabled ? "true" : null;
    var indicatorCurrentYear = DateTime.UtcNow.Year;
    (string Label, string Description, string CssClass) BuildDrinkingWindowIndicator(int? startYear, int? endYear)
    {
        if (startYear is null && endYear is null)
        {
            return ("Prime window unknown", "Save a drinking window from your inventory to see guidance here.", "waves-card-indicator--unknown");
        }

        if (startYear.HasValue && indicatorCurrentYear < startYear.Value)
        {
            var label = "Approaching prime window";
            var description = $"Prime window expected around {startYear.Value.ToString(CultureInfo.InvariantCulture)}.";
            return (label, description, "waves-card-indicator--approaching");
        }

        if (endYear.HasValue && indicatorCurrentYear > endYear.Value)
        {
            var label = "Past prime window";
            var description = $"Prime window ended around {endYear.Value.ToString(CultureInfo.InvariantCulture)}.";
            return (label, description, "waves-card-indicator--past");
        }

        var primeLabel = "In prime window";
        string descriptionText;
        if (startYear.HasValue && endYear.HasValue)
        {
            descriptionText = $"Enjoy between {startYear.Value.ToString(CultureInfo.InvariantCulture)} and {endYear.Value.ToString(CultureInfo.InvariantCulture)}.";
        }
        else if (endYear.HasValue)
        {
            descriptionText = $"Enjoy before {endYear.Value.ToString(CultureInfo.InvariantCulture)}.";
        }
        else if (startYear.HasValue)
        {
            descriptionText = $"Enjoy from {startYear.Value.ToString(CultureInfo.InvariantCulture)} onward.";
        }
        else
        {
            descriptionText = "Enjoy soon.";
        }

        return (primeLabel, descriptionText, "waves-card-indicator--prime");
    }
    (string Name, string? Vintage) SplitWineLabel(string? label)
    {
        if (string.IsNullOrWhiteSpace(label))
        {
            return ("Unnamed wine", null);
        }

        var trimmed = label.Trim();
        var lastSpaceIndex = trimmed.LastIndexOf(' ');
        if (lastSpaceIndex > 0)
        {
            var possibleVintage = trimmed[(lastSpaceIndex + 1)..];
            if (int.TryParse(possibleVintage, NumberStyles.Integer, CultureInfo.InvariantCulture, out _)
                && possibleVintage.Length >= 2
                && possibleVintage.Length <= 4)
            {
                var namePart = trimmed[..lastSpaceIndex].Trim();
                if (namePart.Length > 0)
                {
                    return (namePart, possibleVintage);
                }
            }
        }

        return (trimmed, null);
    }
    string BuildDrinkingWindowRangeText(int? startYear, int? endYear)
    {
        if (startYear.HasValue && endYear.HasValue)
        {
            return $"{startYear.Value.ToString(CultureInfo.InvariantCulture)}–{endYear.Value.ToString(CultureInfo.InvariantCulture)}";
        }

        if (startYear.HasValue)
        {
            return $"From {startYear.Value.ToString(CultureInfo.InvariantCulture)} onward";
        }

        if (endYear.HasValue)
        {
            return $"Enjoy before {endYear.Value.ToString(CultureInfo.InvariantCulture)}";
        }

        return "Prime window unknown";
    }
    var chartPayload = Model.Datasets.Select(dataset => new
    {
        id = dataset.WineVintageId,
        label = dataset.Label,
        color = dataset.ColorHex,
        points = dataset.Points
            .OrderBy(point => point.Year)
            .Select(point => new
            {
                year = point.Year,
                score = Convert.ToDouble(point.Score, CultureInfo.InvariantCulture)
            })
    }).ToList();
    var chartDataJson = JsonSerializer.Serialize(chartPayload);
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wine Waves • Wine Surfer</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#050505" />
    <link rel="stylesheet" href="/css/wine-surfer-theme.css" />
    <link rel="stylesheet" href="/css/wine-surfer-shadcn.css" />
    <link rel="stylesheet" href="/css/wine-surfer-shared-ui.css" />
    <script defer src="/js/pwa.js"></script>
    <style>
        :root {
            color-scheme: dark;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: var(--wine-app-background);
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
            color: hsl(var(--foreground));
            display: flex;
            flex-direction: column;
        }

        .waves-page {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 32px 20px 96px;
        }

        .waves-top,
        .waves-bottom {
            background: var(--wine-surface-gradient-strong);
            border: 1px solid var(--wine-surface-border-strong);
            border-radius: 24px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .waves-top-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .waves-title {
            margin: 0;
            font-size: clamp(1.5rem, 2vw, 2.25rem);
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }

        .waves-description {
            margin: 0;
            color: hsla(var(--foreground) / 0.7);
            line-height: 1.6;
        }

        .waves-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .waves-chart-shell {
            background: hsla(var(--background) / 0.35);
            border-radius: 20px;
            border: 1px solid var(--wine-surface-border);
            min-height: 360px;
            padding: 12px;
        }

        .waves-chart-shell canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .waves-bottom {
            flex: 1;
            min-height: 0;
        }

        .waves-card-list {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding-right: 4px;
        }

        .waves-card-list::-webkit-scrollbar {
            width: 8px;
        }

        .waves-card-list::-webkit-scrollbar-thumb {
            background: hsla(var(--foreground) / 0.25);
            border-radius: 999px;
        }

        .waves-card {
            background: var(--wine-surface-gradient);
            border: 1px solid var(--wine-surface-border);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .waves-card-header {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }

        .waves-card-title {
            display: flex;
            gap: 12px;
            align-items: center;
            min-width: 0;
        }

        .waves-card-dot {
            width: 14px;
            height: 14px;
            border-radius: 999px;
            flex-shrink: 0;
        }

        .waves-card-labels {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .waves-card-label {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .waves-card-vintage {
            font-size: 0.8rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: hsla(var(--foreground) / 0.7);
        }

        .waves-card-delete {
            appearance: none;
            border: none;
            background: hsla(var(--foreground) / 0.08);
            color: hsla(var(--foreground) / 0.8);
            border-radius: 999px;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .waves-card-delete:hover,
        .waves-card-delete:focus-visible {
            background: hsla(var(--foreground) / 0.2);
            color: hsl(var(--foreground));
            outline: none;
        }

        .waves-card-details {
            margin: 0;
            color: hsla(var(--foreground) / 0.75);
            line-height: 1.5;
        }

        .waves-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .waves-card-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.78rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-weight: 600;
        }

        .waves-card-indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
        }

        .waves-card-indicator--approaching {
            background: rgba(246, 198, 114, 0.15);
            color: rgb(246, 198, 114);
        }

        .waves-card-indicator--prime {
            background: rgba(74, 222, 128, 0.15);
            color: rgb(134, 239, 172);
        }

        .waves-card-indicator--past {
            background: rgba(248, 113, 113, 0.18);
            color: rgb(248, 113, 113);
        }

        .waves-card-indicator--unknown {
            background: hsla(var(--foreground) / 0.08);
            color: hsla(var(--foreground) / 0.7);
        }

        .waves-card-window {
            margin: 0;
            font-size: 0.85rem;
            color: hsla(var(--foreground) / 0.8);
        }

        .waves-empty {
            margin: 0;
            text-align: center;
            color: hsla(var(--foreground) / 0.7);
        }

        .waves-popover-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(5, 5, 5, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 1000;
        }

        .waves-popover-dialog {
            background: var(--wine-surface-gradient-strong);
            border: 1px solid var(--wine-surface-border-strong);
            border-radius: 20px;
            padding: 24px;
            max-width: 560px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .waves-popover-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            flex: 1;
        }

        .waves-popover-list {
            border: 1px solid var(--wine-surface-border);
            border-radius: 12px;
            padding: 12px;
            max-height: 320px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .waves-popover-option {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .waves-popover-option:hover,
        .waves-popover-option:focus-within {
            border-color: var(--wine-surface-border);
            background: hsla(var(--foreground) / 0.08);
        }

        .waves-popover-option--unavailable {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .waves-popover-option input {
            margin-top: 4px;
        }

        .waves-popover-filter-input {
            width: 100%;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--wine-surface-border);
            background: hsla(var(--background) / 0.6);
            color: hsl(var(--foreground));
        }

        .waves-popover-option-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .waves-popover-option-label {
            font-weight: 600;
        }

        .waves-popover-option-details {
            font-size: 0.85rem;
            color: hsla(var(--foreground) / 0.8);
        }

        .waves-popover-option-availability {
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: hsla(var(--foreground) / 0.7);
        }

        .waves-primary-button,
        .waves-secondary-button {
            appearance: none;
            border: none;
            border-radius: 999px;
            padding: 10px 22px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }

        .waves-primary-button {
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            box-shadow: 0 10px 24px hsla(var(--primary) / 0.35);
        }

        .waves-secondary-button {
            background: hsla(var(--foreground) / 0.12);
            color: hsla(var(--foreground) / 0.86);
            border: 1px solid hsla(var(--foreground) / 0.24);
        }

        .waves-primary-button:hover,
        .waves-secondary-button:hover {
            transform: translateY(-1px);
        }

        .waves-primary-button:disabled,
        .waves-secondary-button:disabled {
            opacity: 0.65;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .waves-popover-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .waves-popover-backdrop[hidden] {
            display: none;
        }

        @@media (max-width: 640px) {
            .waves-page {
                padding: 24px 16px 96px;
            }

            .waves-top,
            .waves-bottom {
                padding: 20px;
            }
        }
    </style>
</head>
<body class="wine-app wine-app--with-bottom-nav">
    @await Html.PartialAsync("_WineSurferTopBar", topBarModel)
    <main class="waves-page">
        <section class="waves-top" aria-label="Wine Waves chart">
            <div class="waves-top-header">
                <h1 class="waves-title">Wine Waves</h1>
                <p class="waves-description">Track AI-generated evolution scores for every vintage in your cellar.</p>
                <div class="waves-buttons">
                    @await Html.PartialAsync("_MakeWavesButton", hasInventory)
                    <form method="post" data-delete-waves-form>
                        @Html.AntiForgeryToken()
                        <button type="submit"
                                class="wine-surfer-button wine-surfer-button--red"
                                data-delete-waves-trigger
                                disabled="@deleteWavesDisabledAttribute"
                                aria-disabled="@deleteWavesAriaDisabled">
                            Delete all waves
                        </button>
                    </form>
                </div>
            </div>
            @if (hasDatasets)
            {
                <div class="waves-chart-shell">
                    <canvas id="wineWavesChart" role="img" aria-label="Line chart of evolution scores by vintage"></canvas>
                </div>
            }
            else
            {
                <p class="waves-empty">Start scoring your wines to see their evolution unfold here.</p>
            }
        </section>
        <section class="waves-bottom" aria-label="Wine vintage cards">
            @if (hasDatasets)
            {
                <div class="waves-card-list">
                    @foreach (var dataset in Model.Datasets)
                    {
                        var labelParts = SplitWineLabel(dataset.Label);
                        var displayName = string.IsNullOrWhiteSpace(labelParts.Name) ? dataset.Label : labelParts.Name;
                        var displayVintage = labelParts.Vintage;
                        var showVintage = !string.IsNullOrWhiteSpace(displayVintage);
                        var indicator = BuildDrinkingWindowIndicator(dataset.DrinkingWindowStartYear, dataset.DrinkingWindowEndYear);
                        var drinkingWindowRange = BuildDrinkingWindowRangeText(dataset.DrinkingWindowStartYear, dataset.DrinkingWindowEndYear);
                        <article class="waves-card">
                            <div class="waves-card-header">
                                <div class="waves-card-title">
                                    <span class="waves-card-dot" style="background-color: @dataset.ColorHex"></span>
                                    <div class="waves-card-labels">
                                        <p class="waves-card-label">@displayName</p>
                                        @if (showVintage)
                                        {
                                            <span class="waves-card-vintage">@displayVintage</span>
                                        }
                                    </div>
                                </div>
                                <button type="button"
                                        class="waves-card-delete"
                                        data-waves-delete-single
                                        data-wine-vintage-id="@dataset.WineVintageId"
                                        data-wine-label="@dataset.Label"
                                        aria-label="Delete waves for @dataset.Label"
                                        title="Delete waves">
                                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true" width="18" height="18">
                                        <path d="M9 4.5h6M10.5 4.5l.447-1.341A1 1 0 0 1 11.904 2.5h2.192a1 1 0 0 1 .957.659L15.5 4.5M5 7.5h14m-1 0-.732 11.246A2 2 0 0 1 15.272 20.5H8.728a2 2 0 0 1-1.996-1.754L6 7.5"
                                              fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </button>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(dataset.Details))
                            {
                                <p class="waves-card-details">@dataset.Details</p>
                            }
                            <div class="waves-card-meta">
                                <div class="waves-card-indicator @indicator.CssClass" title="@indicator.Description">
                                    <span class="waves-card-indicator-dot" aria-hidden="true"></span>
                                    <span>@indicator.Label</span>
                                </div>
                                <p class="waves-card-window">Prime window: <strong>@drinkingWindowRange</strong></p>
                            </div>
                        </article>
                    }
                </div>
            }
            else
            {
                <p class="waves-empty">No Wine Waves vintages yet. Ask the assistant to make waves above.</p>
            }
        </section>
    </main>

    @if (hasInventory)
    {
        <div class="waves-popover-backdrop" data-make-waves-popover hidden>
            <div class="waves-popover-dialog" role="dialog" aria-modal="true" aria-labelledby="wavesPopoverTitle">
                <form class="waves-popover-form" data-make-waves-form>
                    <h2 id="wavesPopoverTitle">Make waves</h2>
                    <p class="waves-description">Select the vintages you want Wine Waves to analyze for fresh evolution scores.</p>
                    <div>
                        <label class="sr-only" for="wavesPopoverFilter">Filter wines</label>
                        <input type="search" id="wavesPopoverFilter" name="wavesPopoverFilter" class="waves-popover-filter-input" placeholder="Filter wines" autocomplete="off" data-make-waves-filter />
                    </div>
                    <div class="waves-popover-list" role="group" aria-labelledby="wavesPopoverTitle" data-make-waves-list>
                        @for (var index = 0; index < Model.Inventory.Count; index++)
                        {
                            var item = Model.Inventory[index];
                            var optionId = $"waves-option-{index}";
                            var isAvailable = item.AvailableBottleCount > 0;
                            var optionClasses = isAvailable
                                ? "waves-popover-option"
                                : "waves-popover-option waves-popover-option--unavailable";
                            var availabilityText = isAvailable
                                ? (item.AvailableBottleCount == 1
                                    ? "1 bottle available"
                                    : $"{item.AvailableBottleCount} bottles available")
                                : "Not currently available";
                            <label class="@optionClasses" for="@optionId" data-make-waves-option data-available="@isAvailable.ToString().ToLowerInvariant()"@(isAvailable ? string.Empty : " aria-disabled=\"true\"")>
                                <input type="checkbox" id="@optionId" name="wineVintageIds" value="@item.WineVintageId" data-make-waves-checkbox data-initial-disabled="@(!isAvailable).ToString().ToLowerInvariant()" @(isAvailable ? string.Empty : "disabled") />
                                <span class="waves-popover-option-content">
                                    <span class="waves-popover-option-label" data-make-waves-option-label>@item.Label</span>
                                    @if (!string.IsNullOrWhiteSpace(item.Details))
                                    {
                                        <span class="waves-popover-option-details" data-make-waves-option-details>@item.Details</span>
                                    }
                                    <span class="waves-popover-option-availability" data-make-waves-option-status>@availabilityText</span>
                                </span>
                            </label>
                        }
                    </div>
                    <p class="waves-popover-empty waves-empty" data-make-waves-empty hidden role="status" aria-live="polite">No wines match your filter.</p>
                    @Html.AntiForgeryToken()
                    <div class="waves-popover-actions">
                        <button type="button" class="waves-secondary-button" data-make-waves-cancel>Cancel</button>
                        <button type="submit" class="waves-primary-button" data-make-waves-submit>Make waves</button>
                    </div>
                </form>
            </div>
        </div>
    }
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function () {
            const trigger = document.querySelector('[data-make-waves-trigger]');
            const popover = document.querySelector('[data-make-waves-popover]');
            if (!trigger || !popover) {
                return;
            }

            const form = popover.querySelector('[data-make-waves-form]');
            const cancelButton = popover.querySelector('[data-make-waves-cancel]');
            const submitButton = popover.querySelector('[data-make-waves-submit]');
            const filterInput = popover.querySelector('[data-make-waves-filter]');
            const list = popover.querySelector('[data-make-waves-list]');
            const emptyState = popover.querySelector('[data-make-waves-empty]');
            const optionSelector = '[data-make-waves-option]';
            const endpoint = '/wine-surfer/wine-waves/make';
            let lastFocusedElement = null;
            let applyFilter = null;

            const focusFirstCheckbox = () => {
                if (!list) {
                    return;
                }

                const firstCheckbox = list.querySelector(`${optionSelector}:not([hidden]) input[type="checkbox"]:not(:disabled)`);
                if (firstCheckbox && typeof firstCheckbox.focus === 'function') {
                    firstCheckbox.focus();
                    return;
                }

                if (filterInput && typeof filterInput.focus === 'function') {
                    filterInput.focus();
                }
            };

            const closePopover = () => {
                popover.setAttribute('hidden', 'hidden');
                popover.classList.remove('open');
                trigger.setAttribute('aria-expanded', 'false');

                if (filterInput && typeof applyFilter === 'function') {
                    filterInput.value = '';
                    applyFilter();
                }

                if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
                    lastFocusedElement.focus();
                } else {
                    trigger.focus();
                }
            };

            const openPopover = () => {
                if (trigger.hasAttribute('disabled')) {
                    return;
                }

                lastFocusedElement = document.activeElement;
                popover.removeAttribute('hidden');
                popover.classList.add('open');
                trigger.setAttribute('aria-expanded', 'true');

                if (typeof applyFilter === 'function') {
                    applyFilter();
                }

                focusFirstCheckbox();
            };

            if (filterInput && list) {
                const options = Array.from(list.querySelectorAll(optionSelector));
                applyFilter = () => {
                    const query = filterInput.value.trim().toLowerCase();
                    let visibleCount = 0;

                    options.forEach((option) => {
                        const label = option.querySelector('[data-make-waves-option-label]');
                        const details = option.querySelector('[data-make-waves-option-details]');
                        const status = option.querySelector('[data-make-waves-option-status]');
                        const text = [
                            label?.textContent ?? '',
                            details?.textContent ?? '',
                            status?.textContent ?? ''
                        ].join(' ').toLowerCase();

                        const matches = query.length === 0 || text.includes(query);

                        if (!matches) {
                            option.setAttribute('hidden', 'hidden');
                            option.setAttribute('aria-hidden', 'true');
                        } else {
                            option.removeAttribute('hidden');
                            option.removeAttribute('aria-hidden');
                        }

                        const checkbox = option.querySelector('[data-make-waves-checkbox]');
                        if (checkbox) {
                            const initiallyDisabled = checkbox.dataset.initialDisabled === 'true';
                            if (!matches) {
                                checkbox.disabled = true;
                                checkbox.checked = false;
                            } else {
                                checkbox.disabled = initiallyDisabled;
                            }
                        }

                        if (matches) {
                            visibleCount += 1;
                        }
                    });

                    if (emptyState) {
                        emptyState.hidden = visibleCount !== 0;
                    }
                };

                filterInput.addEventListener('input', () => {
                    applyFilter();
                });

                filterInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        focusFirstCheckbox();
                    }
                });

                applyFilter();
            }

            trigger.addEventListener('click', openPopover);

            popover.addEventListener('click', (event) => {
                if (event.target === popover) {
                    closePopover();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && !popover.hasAttribute('hidden')) {
                    closePopover();
                }
            });

            if (cancelButton) {
                cancelButton.addEventListener('click', () => {
                    closePopover();
                });
            }

            if (form && submitButton) {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    const selected = Array.from(form.querySelectorAll('input[name="wineVintageIds"]:checked'))
                        .map((input) => input.value)
                        .filter((value) => typeof value === 'string' && value.trim().length > 0);

                    if (selected.length === 0) {
                        window.alert('Select at least one wine to make new waves.');
                        return;
                    }

                    const originalLabel = submitButton.textContent;
                    submitButton.disabled = true;
                    submitButton.textContent = 'Making waves…';

                    try {
                        const headers = {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        };

                        const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
                        if (tokenInput && tokenInput instanceof HTMLInputElement && tokenInput.value) {
                            headers['RequestVerificationToken'] = tokenInput.value;
                        }

                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers,
                            credentials: 'same-origin',
                            body: JSON.stringify({ wineVintageIds: selected })
                        });

                        const contentType = response.headers.get('content-type') || '';
                        const expectsJson = contentType.toLowerCase().includes('application/json');
                        const payload = expectsJson ? await response.json().catch(() => null) : null;

                        if (!response.ok || !payload) {
                            const errorMessage = payload?.message || 'We could not create new waves. Please try again.';
                            window.alert(errorMessage);
                            return;
                        }

                        window.alert(payload.message || 'Wine Waves updated your evolution scores.');
                        closePopover();
                        window.location.reload();
                    } catch (error) {
                        window.alert('We could not create new waves. Please try again.');
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = originalLabel;
                    }
                });
            }
        })();

        (function () {
            const form = document.querySelector('[data-delete-waves-form]');
            const button = document.querySelector('[data-delete-waves-trigger]');
            if (!form || !button) {
                return;
            }

            const endpoint = '/wine-surfer/wine-waves/delete';

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                if (button.disabled) {
                    return;
                }

                const confirmation = window.confirm('Delete all Wine Waves evolution scores? This cannot be undone.');
                if (!confirmation) {
                    return;
                }

                const originalText = button.textContent;
                const originalDisabled = button.disabled;
                const originalAriaDisabled = button.getAttribute('aria-disabled');

                button.disabled = true;
                button.setAttribute('aria-disabled', 'true');
                button.textContent = 'Deleting…';

                try {
                    const headers = {
                        'Accept': 'application/json'
                    };

                    const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
                    if (tokenInput instanceof HTMLInputElement && tokenInput.value) {
                        headers['RequestVerificationToken'] = tokenInput.value;
                    }

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers,
                        credentials: 'same-origin'
                    });

                    const contentType = response.headers.get('content-type') || '';
                    const expectsJson = contentType.toLowerCase().includes('application/json');
                    const payload = expectsJson ? await response.json().catch(() => null) : null;

                    if (!response.ok || !payload) {
                        const errorMessage = payload?.message || 'We could not delete your waves. Please try again.';
                        window.alert(errorMessage);
                        return;
                    }

                    window.alert(payload.message || 'Deleted all Wine Waves evolution scores.');
                    window.location.reload();
                } catch (error) {
                    window.alert('We could not delete your waves. Please try again.');
                } finally {
                    button.textContent = originalText;

                    if (!originalDisabled) {
                        button.disabled = false;

                        if (originalAriaDisabled === null) {
                            button.removeAttribute('aria-disabled');
                        } else {
                            button.setAttribute('aria-disabled', originalAriaDisabled);
                        }
                    }
                }
            });
        })();

        (function () {
            const buttons = document.querySelectorAll('[data-waves-delete-single]');
            if (!buttons.length) {
                return;
            }

            const tokenInput = document.querySelector('[data-delete-waves-form] input[name="__RequestVerificationToken"]');
            const verificationToken = tokenInput instanceof HTMLInputElement ? tokenInput.value : null;

            buttons.forEach((button) => {
                button.addEventListener('click', async (event) => {
                    event.preventDefault();

                    const wineVintageId = button.getAttribute('data-wine-vintage-id');
                    if (!wineVintageId) {
                        return;
                    }

                    const label = button.getAttribute('data-wine-label') || 'this vintage';
                    const confirmation = window.confirm(`Delete waves for ${label}? This cannot be undone.`);
                    if (!confirmation) {
                        return;
                    }

                    const endpoint = `/wine-surfer/wine-waves/delete/vintage/${wineVintageId}`;
                    const headers = { 'Accept': 'application/json' };
                    if (verificationToken) {
                        headers['RequestVerificationToken'] = verificationToken;
                    }

                    const originalDisabled = button.disabled;
                    const originalAriaDisabled = button.getAttribute('aria-disabled');
                    button.disabled = true;
                    button.setAttribute('aria-disabled', 'true');

                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers,
                            credentials: 'same-origin'
                        });

                        const contentType = response.headers.get('content-type') || '';
                        const expectsJson = contentType.toLowerCase().includes('application/json');
                        const payload = expectsJson ? await response.json().catch(() => null) : null;

                        if (!response.ok || !payload) {
                            const errorMessage = payload?.message || 'We could not delete that wave. Please try again.';
                            window.alert(errorMessage);
                            return;
                        }

                        window.alert(payload.message || 'Deleted Wine Waves evolution scores for the selected vintage.');
                        window.location.reload();
                    } catch (error) {
                        window.alert('We could not delete that wave. Please try again.');
                    } finally {
                        if (!originalDisabled) {
                            button.disabled = false;

                            if (originalAriaDisabled === null) {
                                button.removeAttribute('aria-disabled');
                            } else {
                                button.setAttribute('aria-disabled', originalAriaDisabled);
                            }
                        }
                    }
                });
            });
        })();

        (function () {
            const ctx = document.getElementById('wineWavesChart');
            const data = @Html.Raw(chartDataJson);
            if (!ctx || !Array.isArray(data) || data.length === 0) {
                return;
            }

            const datasets = data.map(dataset => ({
                label: dataset.label,
                data: (dataset.points || []).map(point => ({ x: Number(point.year), y: Number(point.score) })),
                borderColor: dataset.color,
                backgroundColor: dataset.color,
                tension: 0.35,
                borderWidth: 2,
                pointRadius: 0,
                spanGaps: true,
                fill: false
            }));

            new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title(tooltipItems) {
                                    const item = tooltipItems[0];
                                    return `Year ${item.parsed.x}`;
                                },
                                label(tooltipItem) {
                                    const value = Number.parseFloat(tooltipItem.formattedValue).toFixed(1);
                                    return `${tooltipItem.dataset.label}: ${value}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Year'
                            },
                            ticks: {
                                callback(value) {
                                    const numericValue = Number(value);
                                    if (Number.isFinite(numericValue)) {
                                        return Math.round(numericValue).toString();
                                    }

                                    return '';
                                }
                            },
                            grid: {
                                color: 'rgba(244, 241, 234, 0.08)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Evolution Score'
                            },
                            ticks: {
                                callback(value) {
                                    return Number.parseFloat(value).toFixed(0);
                                }
                            },
                            grid: {
                                color: 'rgba(244, 241, 234, 0.08)'
                            }
                        }
                    }
                }
            });
        })();
    </script>
    @await Html.PartialAsync("_WineSurferBottomNav", Context?.Request?.Path.Value)
</body>
</html>
