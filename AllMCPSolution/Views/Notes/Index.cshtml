@model AllMCPSolution.Controllers.NotesController.NotesViewModel
@using AllMCPSolution.Controllers
@using AllMCPSolution.Models
@using System.Globalization
@{
    Layout = null;
    var currentPath = Context?.Request?.Path.Value ?? string.Empty;
    var topBarModel = ViewData["WineSurferTopBarModel"] as WineSurferTopBarModel
        ?? WineSurferTopBarModel.Empty(currentPath);
    ViewData["WineSurferPageTitle"] = "Notes";
    var entries = Model?.Entries ?? Array.Empty<NotesController.NoteEntryViewModel>();
    var entryCount = entries.Count;
    var drinkBottleModalOptions = new DrinkBottleModalViewModel
    {
        Title = "Update tasting note",
        SubmitLabel = "Update note",
        ShowDate = false,
        RequireDate = false,
        FormMethod = "post"
    };
}

@functions {
    private static DateTime NormalizeDateTime(DateTime value)
    {
        return value.Kind switch
        {
            DateTimeKind.Utc => value.ToLocalTime(),
            DateTimeKind.Unspecified => DateTime.SpecifyKind(value, DateTimeKind.Local),
            _ => value
        };
    }

    private static DateTime? NormalizeDateTime(DateTime? value)
    {
        return value.HasValue ? NormalizeDateTime(value.Value) : (DateTime?)null;
    }

    private static string FormatDrunkDate(DateTime? drunkAt)
    {
        var normalized = NormalizeDateTime(drunkAt);
        return normalized.HasValue ? normalized.Value.ToString("MMM d, yyyy") : "—";
    }

    private static string FormatScore(decimal? score)
    {
        return score.HasValue ? score.Value.ToString("0.0") : "—";
    }

    private static string FormatLocation(string appellation, string region)
    {
        var hasAppellation = !string.IsNullOrWhiteSpace(appellation);
        var hasRegion = !string.IsNullOrWhiteSpace(region);

        return (hasAppellation, hasRegion) switch
        {
            (false, false) => string.Empty,
            (true, false) => appellation,
            (false, true) => region,
            _ => $"{appellation} ({region})"
        };
    }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wine Surfer · Notes</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#050505" />
    <link rel="stylesheet" href="/css/wine-surfer-theme.css" />
    <link rel="stylesheet" href="/css/wine-surfer-shadcn.css" />
    <link rel="stylesheet" href="/css/wine-surfer-shared-ui.css" />
    <script defer src="/js/pwa.js"></script>
    <style>
        :root {
            color-scheme: dark;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: var(--wine-app-background);
            color: hsl(var(--foreground));
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
        }

        .notes-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .notes-page__content {
            padding: 20px 16px 88px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .notes-table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            background: transparent;
        }

        .notes-table__empty {
            text-align: center;
            padding: 32px 16px;
            color: hsla(var(--foreground) / 0.7);
            font-size: 0.95rem;
        }

        .notes-table__note {
            margin: 0;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .notes-table__muted {
            color: hsla(var(--foreground) / 0.6);
        }

        .notes-table__row {
            cursor: pointer;
        }

        .notes-table__row:hover {
            background: hsla(var(--foreground) / 0.08);
        }

        .notes-table__row:focus {
            outline: none;
        }

        .notes-table__row:focus-visible {
            outline: 2px solid hsl(var(--foreground));
            outline-offset: -2px;
        }

        .summary-cell--note {
            width: 40%;
        }

        .summary-cell--date,
        .summary-cell--score,
        .summary-cell--vintage {
            white-space: nowrap;
        }

        @@media (min-width: 900px) {
            .notes-page__content {
                padding: 32px 24px 96px;
            }
        }
    </style>
</head>
<body class="wine-app wine-app--with-bottom-nav">
    <div class="notes-page">
        @await Html.PartialAsync("_WineSurferTopBar", topBarModel)
        <main class="notes-page__content">
            <div class="notes-table-wrapper">
                <table class="crud-table__table notes-table" data-crud-table="notes-table">
                    <thead>
                        <tr class="crud-table__header-row">
                            <th class="summary-header summary-header--wine"><span class="header-text">Wine</span></th>
                            <th class="summary-header summary-header--appellation"><span class="header-text">Origin</span></th>
                            <th class="summary-header summary-header--vintage"><span class="header-text">Vintage</span></th>
                            <th class="summary-header summary-header--date"><span class="header-text">Drank</span></th>
                            <th class="summary-header summary-header--score"><span class="header-text">Score</span></th>
                            <th class="summary-header summary-header--note"><span class="header-text">Note</span></th>
                        </tr>
                    </thead>
                    <tbody>
                    @if (entryCount > 0)
                    {
                        foreach (var entry in entries)
                        {
                            var location = FormatLocation(entry.Appellation, entry.Region);
                            var noteRaw = entry.Note ?? string.Empty;
                            var isNotTasted = entry.NotTasted;
                            var noteText = isNotTasted
                                ? "You marked this bottle as not tasted."
                                : (string.IsNullOrWhiteSpace(noteRaw)
                                    ? "No tasting note recorded yet."
                                    : noteRaw);
                            var scoreAttribute = entry.Score.HasValue
                                ? entry.Score.Value.ToString("0.0", CultureInfo.InvariantCulture)
                                : string.Empty;
                            var normalizedDate = NormalizeDateTime(entry.DrunkAt)?.ToString("yyyy-MM-dd") ?? string.Empty;
                            var label = string.IsNullOrWhiteSpace(entry.WineName)
                                ? "Bottle"
                                : entry.WineName.Trim();
                            if (entry.Vintage.HasValue && entry.Vintage.Value > 0)
                            {
                                label = string.IsNullOrWhiteSpace(label)
                                    ? entry.Vintage.Value.ToString(CultureInfo.InvariantCulture)
                                    : $"{label} {entry.Vintage.Value.ToString(CultureInfo.InvariantCulture)}";
                            }
                            <tr class="crud-table__row notes-table__row"
                                data-note-row
                                data-bottle-id="@entry.BottleId"
                                data-note-id="@entry.NoteId"
                                data-note-label="@label"
                                data-note-text="@noteRaw"
                                data-note-score="@scoreAttribute"
                                data-note-date="@normalizedDate"
                                data-note-not-tasted="@(isNotTasted ? "true" : "false")"
                                tabindex="0"
                                role="button"
                                aria-label="Edit tasting note for @label">
                                <td class="summary-cell summary-cell--wine">
                                    @if (entry.WineId != Guid.Empty)
                                    {
                                        <a class="link" href="/wine/@entry.WineId">@entry.WineName</a>
                                    }
                                    else
                                    {
                                        <span>@entry.WineName</span>
                                    }
                                </td>
                                <td class="summary-cell summary-cell--appellation">
                                    @if (string.IsNullOrWhiteSpace(location))
                                    {
                                        <span class="notes-table__muted">—</span>
                                    }
                                    else
                                    {
                                        <span>@location</span>
                                    }
                                </td>
                                <td class="summary-cell summary-cell--vintage">
                                    @(entry.Vintage?.ToString() ?? "—")
                                </td>
                                <td class="summary-cell summary-cell--date">@FormatDrunkDate(entry.DrunkAt)</td>
                                <td class="summary-cell summary-cell--score">@FormatScore(entry.Score)</td>
                                <td class="summary-cell summary-cell--note">
                                    <p class="notes-table__note">@noteText</p>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="notes-table__empty">Start tracking your tasting impressions by marking bottles as drunk from your inventory.</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    @await Html.PartialAsync("_DrinkBottleModal", drinkBottleModalOptions)
    @await Html.PartialAsync("_WineSurferBottomNav", Context?.Request?.Path.Value)
    <script defer src="/js/drink-bottle-modal.js"></script>
    <script defer src="/js/notes.js"></script>
</body>
</html>
